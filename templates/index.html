<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 翻译与译审对话系统（Chat-based）</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #3f4652;
            --primary-hover: #2f3540;
            --surface: rgba(255, 255, 255, 0.78);
            --surface-strong: rgba(255, 255, 255, 0.92);
            --surface-muted: rgba(241, 245, 249, 0.85);
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: rgba(148, 163, 184, 0.35);
            --shadow-lg: 0 24px 45px -30px rgba(15, 23, 42, 0.6);
            --shadow-md: 0 14px 30px -22px rgba(15, 23, 42, 0.4);
            --sidebar-bg: rgba(15, 23, 42, 0.92);
            --sidebar-text: #e2e8f0;
            --sidebar-muted: rgba(226, 232, 240, 0.6);
            --success: #16a34a;
            --error: #dc2626;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.9), rgba(226, 232, 240, 0.6));
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 10% 20%, rgba(248, 250, 252, 0.9), transparent 55%),
                        radial-gradient(circle at 80% 0%, rgba(148, 163, 184, 0.18), transparent 40%),
                        radial-gradient(circle at 80% 80%, rgba(203, 213, 225, 0.25), transparent 45%);
            pointer-events: none;
            z-index: -1;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 100vh;
            gap: 24px;
            padding: 24px;
        }

        .sidebar {
            background: var(--sidebar-bg);
            border-radius: 24px;
            padding: 24px;
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.2em;
        }

        .sidebar-toggle {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
            color: var(--sidebar-text);
            cursor: pointer;
        }

        .sidebar-collapsed .app-shell {
            grid-template-columns: 88px 1fr;
        }

        .sidebar-collapsed .sidebar-title,
        .sidebar-collapsed .history-title,
        .sidebar-collapsed .history-meta,
        .sidebar-collapsed .new-chat-btn span {
            display: none;
        }

        .sidebar-collapsed .new-chat-btn {
            justify-content: center;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
            color: var(--sidebar-text);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            max-height: calc(100vh - 220px);
        }

        .history-item {
            padding: 12px 14px;
            border-radius: 14px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .history-item.active {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.12);
        }

        .history-title {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .history-meta {
            font-size: 0.75rem;
            color: var(--sidebar-muted);
        }

        .main-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .top-bar {
            background: var(--surface);
            border-radius: 20px;
            padding: 18px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .brand h1 {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .brand span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .mode-select,
        .model-input {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--surface-strong);
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .settings-btn {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--surface-strong);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .chat-area {
            background: var(--surface);
            border-radius: 24px;
            padding: 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
            min-height: 60vh;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 18px;
        }

        .message {
            display: flex;
            gap: 12px;
            max-width: 85%;
        }

        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            color: #fff;
        }

        .avatar-user {
            background: #475569;
        }

        .avatar-ai {
            background: #64748b;
        }

        .message-bubble {
            background: var(--surface-strong);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 14px 16px;
            font-size: 0.95rem;
        }

        .message.user .message-bubble {
            background: #475569;
            color: #fff;
            border-color: transparent;
        }

        .message-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .message-actions {
            margin-top: 10px;
            display: flex;
            gap: 8px;
        }

        .compare-btn {
            border: none;
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .input-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .input-panel textarea,
        .input-panel input,
        .input-panel select {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            font-size: 0.9rem;
            background: var(--surface-strong);
            color: var(--text-primary);
        }

        .input-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .send-btn {
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .status {
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            display: none;
        }

        .status.success {
            display: block;
            background: rgba(22, 163, 74, 0.12);
            color: var(--success);
        }

        .status.error {
            display: block;
            background: rgba(220, 38, 38, 0.12);
            color: var(--error);
        }

        .loader-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, #f8fafc 0%, #e2e8f0 45%, #f1f5f9 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader-card {
            width: min(520px, 85vw);
            padding: 30px;
            border-radius: 28px;
            background: rgba(255, 255, 255, 0.72);
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .loader-progress {
            margin-top: 18px;
            height: 6px;
            border-radius: 10px;
            background: rgba(148, 163, 184, 0.3);
            overflow: hidden;
        }

        .loader-progress span {
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #334155, #64748b, #94a3b8);
            animation: progressLoad 2s linear forwards;
        }

        @keyframes progressLoad {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .modal {
            width: min(520px, 90vw);
            background: var(--surface-strong);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .modal h3 {
            margin-bottom: 12px;
        }

        .modal-actions {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-actions button {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--primary-color);
            color: #fff;
        }

        .compare-modal-content {
            display: flex;
            gap: 16px;
            margin-top: 16px;
        }

        .compare-panel {
            flex: 1;
            border-radius: 14px;
            padding: 14px;
            background: var(--surface-muted);
            border: 1px solid var(--border-color);
        }

        .diff-add {
            background: rgba(34, 197, 94, 0.2);
            border-radius: 6px;
            padding: 0 3px;
        }

        .diff-remove {
            background: rgba(239, 68, 68, 0.15);
            border-radius: 6px;
            padding: 0 3px;
        }

        @media (max-width: 960px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .main-panel {
                order: 1;
            }

            .top-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .message {
                max-width: 100%;
            }

            .compare-modal-content {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="loader-overlay" id="loader">
        <div class="loader-card">
            <h2>AI 翻译与译审对话系统</h2>
            <p style="margin-top: 6px; color: var(--text-secondary);">Chat-based unified workflow</p>
            <div class="loader-progress"><span></span></div>
        </div>
    </div>

    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal">
            <h3>输入 API Key</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">仅首次使用需要输入，可在设置中清除缓存。</p>
            <input type="password" id="apiKeyInput" placeholder="sk-..." style="width: 100%; margin-top: 12px;">
            <div class="modal-actions">
                <button class="btn-secondary" id="apiKeyClear">清除</button>
                <button class="btn-primary" id="apiKeySave">保存</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="compareModal">
        <div class="modal" style="width: min(800px, 95vw);">
            <h3>与其他模型结果对比</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">输入其他模型名称后生成对比结果。</p>
            <input type="text" id="compareModelInput" placeholder="例如：openai/gpt-4o" style="width: 100%; margin-top: 12px;">
            <div class="compare-modal-content" id="compareResults"></div>
            <div class="modal-actions">
                <button class="btn-secondary" id="compareClose">关闭</button>
                <button class="btn-primary" id="compareRun">开始对比</button>
            </div>
        </div>
    </div>

    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">CHAT</div>
                <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>
            </div>
            <button class="new-chat-btn" id="newChatBtn"><i class="fas fa-plus"></i> <span>新建对话</span></button>
            <div class="history-list" id="historyList"></div>
        </aside>

        <main class="main-panel">
            <div class="top-bar">
                <div class="brand">
                    <h1>AI 翻译与译审对话系统</h1>
                    <span>Chat-based</span>
                </div>
                <div class="control-group">
                    <select class="mode-select" id="modeSelect">
                        <option value="interactive">交互翻译</option>
                        <option value="document">文档翻译</option>
                        <option value="review">AI 译审</option>
                    </select>
                    <input class="model-input" id="modelInput" type="text" placeholder="模型名称（OpenRouter）">
                    <button class="settings-btn" id="apiKeySettings"><i class="fas fa-key"></i> API Key</button>
                </div>
            </div>

            <section class="chat-area">
                <div class="messages" id="messages"></div>
                <div class="status" id="statusBox"></div>
                <div class="input-panel" id="inputPanel"></div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const loader = document.getElementById('loader');
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeySave = document.getElementById('apiKeySave');
        const apiKeyClear = document.getElementById('apiKeyClear');
        const apiKeySettings = document.getElementById('apiKeySettings');
        const compareModal = document.getElementById('compareModal');
        const compareModelInput = document.getElementById('compareModelInput');
        const compareResults = document.getElementById('compareResults');
        const compareRun = document.getElementById('compareRun');
        const compareClose = document.getElementById('compareClose');
        const modeSelect = document.getElementById('modeSelect');
        const modelInput = document.getElementById('modelInput');
        const messagesEl = document.getElementById('messages');
        const inputPanel = document.getElementById('inputPanel');
        const statusBox = document.getElementById('statusBox');
        const historyList = document.getElementById('historyList');
        const newChatBtn = document.getElementById('newChatBtn');
        const sidebarToggle = document.getElementById('sidebarToggle');

        const STORAGE_API_KEY = 'globalApiKey';
        const STORAGE_CONVERSATIONS = 'chatConversations';
        const STORAGE_ACTIVE = 'activeConversationId';

        const modes = {
            interactive: '交互翻译',
            document: '文档翻译',
            review: 'AI 译审'
        };

        let conversations = [];
        let activeConversationId = null;
        let compareContext = null;

        function loadState() {
            const storedConversations = localStorage.getItem(STORAGE_CONVERSATIONS);
            if (storedConversations) {
                try {
                    conversations = JSON.parse(storedConversations);
                } catch (error) {
                    conversations = [];
                }
            }
            if (conversations.length === 0) {
                createConversation();
            } else {
                activeConversationId = localStorage.getItem(STORAGE_ACTIVE) || conversations[0].id;
            }
        }

        function saveState() {
            localStorage.setItem(STORAGE_CONVERSATIONS, JSON.stringify(conversations));
            if (activeConversationId) {
                localStorage.setItem(STORAGE_ACTIVE, activeConversationId);
            }
        }

        function createConversation() {
            const id = `conv_${Date.now()}`;
            const conversation = {
                id,
                title: '新对话',
                mode: 'interactive',
                model: '',
                messages: []
            };
            conversations.unshift(conversation);
            activeConversationId = id;
            saveState();
            renderHistory();
            renderConversation();
        }

        function getActiveConversation() {
            return conversations.find(conv => conv.id === activeConversationId);
        }

        function renderHistory() {
            historyList.innerHTML = '';
            conversations.forEach(conv => {
                const item = document.createElement('div');
                item.className = 'history-item' + (conv.id === activeConversationId ? ' active' : '');
                item.innerHTML = `
                    <div class="history-title">${conv.title}</div>
                    <div class="history-meta">${modes[conv.mode]}</div>
                `;
                item.addEventListener('click', () => {
                    activeConversationId = conv.id;
                    saveState();
                    renderHistory();
                    renderConversation();
                });
                historyList.appendChild(item);
            });
        }

        function renderConversation() {
            const conversation = getActiveConversation();
            if (!conversation) return;
            modeSelect.value = conversation.mode;
            modelInput.value = conversation.model || '';
            messagesEl.innerHTML = '';
            conversation.messages.forEach(message => {
                messagesEl.appendChild(renderMessage(message));
            });
            renderInputPanel(conversation.mode);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function renderMessage(message) {
            const wrapper = document.createElement('div');
            wrapper.className = `message ${message.role}`;
            const avatar = document.createElement('div');
            avatar.className = `message-avatar ${message.role === 'user' ? 'avatar-user' : 'avatar-ai'}`;
            avatar.innerHTML = message.role === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            bubble.innerHTML = marked.parse(message.content || '');

            const container = document.createElement('div');
            container.appendChild(bubble);

            if (message.role === 'assistant' && message.comparePayload) {
                const actions = document.createElement('div');
                actions.className = 'message-actions';
                const compareButton = document.createElement('button');
                compareButton.className = 'compare-btn';
                compareButton.innerHTML = '<i class="fas fa-flag"></i> 对比';
                compareButton.addEventListener('click', () => openCompareModal(message));
                actions.appendChild(compareButton);
                container.appendChild(actions);
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(container);
            return wrapper;
        }

        function renderInputPanel(mode) {
            inputPanel.innerHTML = '';
            statusBox.style.display = 'none';

            if (mode === 'interactive') {
                inputPanel.innerHTML = `
                    <textarea id="chatInput" rows="4" placeholder="输入原文或翻译指令..."></textarea>
                    <div class="input-actions">
                        <button class="send-btn" id="sendBtn">发送</button>
                    </div>
                `;
                document.getElementById('sendBtn').addEventListener('click', handleInteractiveSend);
            }

            if (mode === 'document') {
                inputPanel.innerHTML = `
                    <input type="file" id="docFile" accept=".txt,.doc,.docx" />
                    <textarea id="docNotes" rows="3" placeholder="补充说明（可选）"></textarea>
                    <div class="input-actions">
                        <button class="send-btn" id="sendDocBtn">上传翻译</button>
                    </div>
                `;
                document.getElementById('sendDocBtn').addEventListener('click', handleDocumentSend);
            }

            if (mode === 'review') {
                inputPanel.innerHTML = `
                    <textarea id="reviewSource" rows="3" placeholder="原文"></textarea>
                    <textarea id="reviewTarget" rows="3" placeholder="译文"></textarea>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 12px;">
                        <select id="reviewSourceLang">
                            <option value="auto">源语言自动匹配</option>
                            <option value="中文">中文</option>
                            <option value="英文">英文</option>
                            <option value="日文">日文</option>
                            <option value="韩文">韩文</option>
                        </select>
                        <select id="reviewTargetLang">
                            <option value="auto">目标语言自动匹配</option>
                            <option value="中文">中文</option>
                            <option value="英文">英文</option>
                            <option value="日文">日文</option>
                            <option value="韩文">韩文</option>
                        </select>
                    </div>
                    <div class="input-actions">
                        <button class="send-btn" id="sendReviewBtn">开始译审</button>
                    </div>
                `;
                document.getElementById('sendReviewBtn').addEventListener('click', handleReviewSend);
            }
        }

        function updateConversationTitle(conversation, text) {
            if (conversation.title !== '新对话') return;
            const trimmed = text.trim();
            if (trimmed) {
                conversation.title = trimmed.slice(0, 12);
            }
        }

        function appendMessage(conversation, message) {
            conversation.messages.push(message);
            messagesEl.appendChild(renderMessage(message));
            messagesEl.scrollTop = messagesEl.scrollHeight;
            saveState();
            renderHistory();
        }

        function showStatus(message, type) {
            statusBox.textContent = message;
            statusBox.className = `status ${type}`;
        }

        async function handleInteractiveSend() {
            const conversation = getActiveConversation();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }
            if (!conversation.model) {
                showStatus('请先输入模型名称。', 'error');
                return;
            }

            updateConversationTitle(conversation, text);
            appendMessage(conversation, { role: 'user', content: text });
            input.value = '';

            showStatus('翻译中...', 'success');
            try {
                const response = await fetch('/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_message: text,
                        api_key: apiKey,
                        model: conversation.model,
                        temperature: 1.0,
                        source_lang: 'auto',
                        target_lang: '中文',
                        system_prompt: ''
                    })
                });
                const result = await response.json();
                if (result.error) {
                    showStatus(result.error, 'error');
                    return;
                }
                appendMessage(conversation, {
                    role: 'assistant',
                    content: result.translation,
                    comparePayload: {
                        mode: 'interactive',
                        baseOutput: result.translation,
                        inputText: text,
                        sourceLang: 'auto',
                        targetLang: '中文'
                    }
                });
                showStatus('完成', 'success');
            } catch (error) {
                showStatus('请求失败，请重试。', 'error');
            }
        }

        async function handleDocumentSend() {
            const conversation = getActiveConversation();
            const fileInput = document.getElementById('docFile');
            const notesInput = document.getElementById('docNotes');
            const file = fileInput.files[0];
            if (!file) {
                showStatus('请先上传文档。', 'error');
                return;
            }
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }
            if (!conversation.model) {
                showStatus('请先输入模型名称。', 'error');
                return;
            }

            appendMessage(conversation, { role: 'user', content: `上传文档：${file.name}\n${notesInput.value.trim()}`.trim() });
            showStatus('文档翻译处理中...', 'success');

            const formData = new FormData();
            formData.append('file', file);
            formData.append('api_key', apiKey);
            formData.append('model', conversation.model);
            formData.append('temperature', '1.0');
            formData.append('source_lang', 'auto');
            formData.append('target_lang', '中文');
            formData.append('system_prompt', notesInput.value || '');
            formData.append('user_prompt', notesInput.value || '');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.error) {
                    showStatus(result.error, 'error');
                    return;
                }
                appendMessage(conversation, {
                    role: 'assistant',
                    content: `文档翻译完成，可下载：\n[下载链接](/download/${result.output_file})`
                });
                showStatus('完成', 'success');
            } catch (error) {
                showStatus('上传失败，请重试。', 'error');
            }
        }

        async function handleReviewSend() {
            const conversation = getActiveConversation();
            const sourceText = document.getElementById('reviewSource').value.trim();
            const targetText = document.getElementById('reviewTarget').value.trim();
            const sourceLang = document.getElementById('reviewSourceLang').value;
            const targetLang = document.getElementById('reviewTargetLang').value;
            if (!sourceText || !targetText) {
                showStatus('请输入原文与译文。', 'error');
                return;
            }
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }
            if (!conversation.model) {
                showStatus('请先输入模型名称。', 'error');
                return;
            }

            appendMessage(conversation, { role: 'user', content: `AI 译审请求\n原文：${sourceText}\n译文：${targetText}` });
            showStatus('译审中...', 'success');

            try {
                const response = await fetch('/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: 'single',
                        source_text: sourceText,
                        target_text: targetText,
                        source_lang: sourceLang,
                        target_lang: targetLang,
                        config: {
                            api_key: apiKey,
                            model: conversation.model
                        }
                    })
                });
                const result = await response.json();
                if (result.error) {
                    showStatus(result.error, 'error');
                    return;
                }
                const reviewText = `评分：${result.score || 'N/A'}\n\n评估：\n${result.review || ''}\n\n建议：\n${result.suggestions || ''}`;
                appendMessage(conversation, {
                    role: 'assistant',
                    content: reviewText,
                    comparePayload: {
                        mode: 'review',
                        baseOutput: reviewText,
                        sourceText,
                        targetText,
                        sourceLang,
                        targetLang
                    }
                });
                showStatus('完成', 'success');
            } catch (error) {
                showStatus('译审失败，请重试。', 'error');
            }
        }

        function openApiModal() {
            apiKeyModal.style.display = 'flex';
            const storedKey = localStorage.getItem(STORAGE_API_KEY) || '';
            apiKeyInput.value = storedKey;
            apiKeyClear.disabled = !storedKey;
        }

        function closeApiModal() {
            apiKeyModal.style.display = 'none';
        }

        apiKeySave.addEventListener('click', () => {
            const value = apiKeyInput.value.trim();
            if (value) {
                localStorage.setItem(STORAGE_API_KEY, value);
                closeApiModal();
                showStatus('API Key 已保存。', 'success');
            }
        });

        apiKeyClear.addEventListener('click', () => {
            localStorage.removeItem(STORAGE_API_KEY);
            apiKeyInput.value = '';
            apiKeyClear.disabled = true;
        });
        apiKeySettings.addEventListener('click', openApiModal);

        function openCompareModal(message) {
            compareContext = message.comparePayload;
            compareResults.innerHTML = '';
            compareModelInput.value = '';
            compareModal.style.display = 'flex';
        }

        compareClose.addEventListener('click', () => {
            compareModal.style.display = 'none';
            compareContext = null;
        });

        compareRun.addEventListener('click', async () => {
            if (!compareContext) return;
            const modelName = compareModelInput.value.trim();
            if (!modelName) return;
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }

            compareResults.innerHTML = '<div class="compare-panel">对比生成中...</div>';
            try {
                let baseText = '';
                let compareText = '';

                if (compareContext.mode === 'interactive') {
                    baseText = compareContext.baseOutput;
                    const response = await fetch('/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_message: compareContext.inputText,
                            api_key: apiKey,
                            model: modelName,
                            temperature: 1.0,
                            source_lang: compareContext.sourceLang,
                            target_lang: compareContext.targetLang,
                            system_prompt: ''
                        })
                    });
                    const result = await response.json();
                    compareText = result.translation || result.error || '';
                }

                if (compareContext.mode === 'review') {
                    baseText = compareContext.baseOutput;
                    const response = await fetch('/review', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            mode: 'single',
                            source_text: compareContext.sourceText,
                            target_text: compareContext.targetText,
                            source_lang: compareContext.sourceLang,
                            target_lang: compareContext.targetLang,
                            config: { api_key: apiKey, model: modelName }
                        })
                    });
                    const result = await response.json();
                    compareText = result.review || result.error || '';
                }

                const diff = createDiff(baseText, compareText);
                compareResults.innerHTML = `
                    <div class="compare-panel">
                        <h4>当前模型</h4>
                        <div>${diff.base}</div>
                    </div>
                    <div class="compare-panel">
                        <h4>${modelName}</h4>
                        <div>${diff.compare}</div>
                    </div>
                `;
            } catch (error) {
                compareResults.innerHTML = '<div class="compare-panel">对比失败，请重试。</div>';
            }
        });

        function createDiff(baseText, compareText) {
            const baseTokens = tokenize(baseText);
            const compareTokens = tokenize(compareText);
            const lcsMatrix = Array(baseTokens.length + 1).fill(null).map(() => Array(compareTokens.length + 1).fill(0));

            for (let i = 1; i <= baseTokens.length; i++) {
                for (let j = 1; j <= compareTokens.length; j++) {
                    if (baseTokens[i - 1] === compareTokens[j - 1]) {
                        lcsMatrix[i][j] = lcsMatrix[i - 1][j - 1] + 1;
                    } else {
                        lcsMatrix[i][j] = Math.max(lcsMatrix[i - 1][j], lcsMatrix[i][j - 1]);
                    }
                }
            }

            let i = baseTokens.length;
            let j = compareTokens.length;
            const baseOutput = [];
            const compareOutput = [];

            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && baseTokens[i - 1] === compareTokens[j - 1]) {
                    baseOutput.unshift(baseTokens[i - 1]);
                    compareOutput.unshift(compareTokens[j - 1]);
                    i--;
                    j--;
                } else if (j > 0 && (i === 0 || lcsMatrix[i][j - 1] >= lcsMatrix[i - 1][j])) {
                    compareOutput.unshift(`<span class="diff-add">${compareTokens[j - 1]}</span>`);
                    j--;
                } else if (i > 0) {
                    baseOutput.unshift(`<span class="diff-remove">${baseTokens[i - 1]}</span>`);
                    i--;
                }
            }

            return {
                base: baseOutput.join(' '),
                compare: compareOutput.join(' ')
            };
        }

        function tokenize(text) {
            return text.replace(/\s+/g, ' ').trim().split(' ').filter(Boolean);
        }

        modeSelect.addEventListener('change', () => {
            const conversation = getActiveConversation();
            if (!conversation) return;
            conversation.mode = modeSelect.value;
            saveState();
            renderHistory();
            renderInputPanel(conversation.mode);
        });

        modelInput.addEventListener('input', () => {
            const conversation = getActiveConversation();
            if (!conversation) return;
            conversation.model = modelInput.value.trim();
            saveState();
        });

        newChatBtn.addEventListener('click', createConversation);

        sidebarToggle.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-collapsed');
        });

        function initLoader() {
            setTimeout(() => {
                loader.style.display = 'none';
                const storedKey = localStorage.getItem(STORAGE_API_KEY);
                if (!storedKey) {
                    openApiModal();
                }
            }, 2000);
        }

        loadState();
        renderHistory();
        renderConversation();
        initLoader();
    </script>
</body>
</html>
