<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 翻译与译审对话系统</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #3f4652;
            --primary-hover: #2f3540;
            --surface: rgba(255, 255, 255, 0.78);
            --surface-strong: rgba(255, 255, 255, 0.92);
            --surface-muted: rgba(241, 245, 249, 0.85);
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: rgba(148, 163, 184, 0.35);
            --shadow-lg: 0 24px 45px -30px rgba(15, 23, 42, 0.6);
            --shadow-md: 0 14px 30px -22px rgba(15, 23, 42, 0.4);
            --sidebar-bg: rgba(15, 23, 42, 0.92);
            --sidebar-text: #e2e8f0;
            --sidebar-muted: rgba(226, 232, 240, 0.6);
            --success: #16a34a;
            --error: #dc2626;
            --info: #2563eb;
            --bubble-user: #3f4652;
            --bubble-assistant: rgba(255, 255, 255, 0.92);
            --bubble-border: rgba(148, 163, 184, 0.35);
            --bubble-shadow: 0 18px 32px -26px rgba(15, 23, 42, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "微软雅黑", "Segoe UI", Arial, sans-serif;
            background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.9), rgba(226, 232, 240, 0.6));
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow: hidden;
        }

        button,
        input,
        textarea,
        select {
            font-family: "Microsoft YaHei", "微软雅黑", "Segoe UI", Arial, sans-serif;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 10% 20%, rgba(248, 250, 252, 0.9), transparent 55%),
                        radial-gradient(circle at 80% 0%, rgba(148, 163, 184, 0.18), transparent 40%),
                        radial-gradient(circle at 80% 80%, rgba(203, 213, 225, 0.25), transparent 45%);
            pointer-events: none;
            z-index: -1;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 100vh;
            gap: 24px;
            padding: 24px;
            height: 100vh;
        }

        .sidebar {
            background: var(--sidebar-bg);
            border-radius: 24px;
            padding: 24px;
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.2em;
        }

        .sidebar-toggle {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
            color: var(--sidebar-text);
            cursor: pointer;
        }

        .sidebar-collapsed .app-shell {
            grid-template-columns: 88px 1fr;
        }

        .sidebar-collapsed .sidebar-title,
        .sidebar-collapsed .history-title,
        .sidebar-collapsed .history-meta,
        .sidebar-collapsed .new-chat-btn span,
        .sidebar-collapsed .review-entry span,
        .sidebar-collapsed .history-actions {
            display: none;
        }

        .sidebar-collapsed .new-chat-btn {
            justify-content: center;
        }

        .sidebar-collapsed .review-entry {
            justify-content: center;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
            color: var(--sidebar-text);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .review-entry {
            flex: 1;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px dashed rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.06);
            color: var(--sidebar-muted);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .api-key-entry {
            width: 42px;
            height: 42px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.08);
            color: var(--sidebar-text);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .review-entry.active {
            border-color: rgba(255, 255, 255, 0.4);
            color: var(--sidebar-text);
        }

        .history-item {
            padding: 12px 14px;
            border-radius: 14px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .history-item.active {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.12);
        }

        .history-title {
            font-size: 0.9rem;
            font-weight: 600;
            word-break: break-word;
        }

        .history-title-input {
            width: 100%;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
            color: var(--sidebar-text);
            font-size: 0.9rem;
            padding: 4px 8px;
        }

        .history-actions {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .history-action-btn {
            width: 30px;
            height: 30px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.08);
            color: var(--sidebar-text);
            cursor: pointer;
            flex-shrink: 0;
        }

        .history-meta {
            font-size: 0.75rem;
            color: var(--sidebar-muted);
        }

        .main-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .top-bar {
            background: var(--surface);
            border-radius: 20px;
            padding: 18px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .brand-row {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .model-label {
            font-size: 0.85rem;
            color: var(--text-secondary);
            font-weight: 600;
            letter-spacing: 0.04em;
        }

        .brand h1 {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .model-input {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--surface-strong);
            font-size: 0.9rem;
            color: var(--text-primary);
            min-width: 240px;
        }

        .settings-btn {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--surface-strong);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .chat-area {
            background: var(--surface);
            border-radius: 24px;
            padding: 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
            min-height: 60vh;
            min-height: 0;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .message {
            display: flex;
            flex-direction: column;
            gap: 6px;
            max-width: 78%;
        }

        .message.user {
            align-self: flex-end;
            align-items: flex-end;
        }

        .message.assistant {
            align-self: flex-start;
            align-items: flex-start;
        }

        .message-bubble {
            background: var(--bubble-assistant);
            border: 1px solid var(--bubble-border);
            border-radius: 18px;
            padding: 12px 16px;
            font-size: 0.98rem;
            box-shadow: var(--bubble-shadow);
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        .message.user .message-bubble {
            background: var(--bubble-user);
            color: #f8fafc;
            border-color: transparent;
        }

        .message-bubble p {
            margin: 0 0 0.7em;
        }

        .message-bubble p:last-child {
            margin-bottom: 0;
        }

        .message-bubble a {
            color: inherit;
            text-decoration: underline;
        }

        .message-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .message-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            align-items: center;
        }

        .compare-btn {
            border: none;
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .compare-nav {
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .compare-icon-btn {
            width: 28px;
            height: 28px;
            border-radius: 8px;
            border: none;
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .compare-index {
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .message-footer {
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .message-source {
            font-size: 0.78rem;
            color: var(--text-secondary);
        }

        .review-record {
            background: var(--surface-strong);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 14px 16px;
        }

        .review-record-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .review-record-title {
            font-weight: 600;
            margin-bottom: 6px;
        }

        .review-record-empty {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .input-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .input-toolbar {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }

        .input-shell {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 4px 10px;
            border-radius: 16px;
            border: 1px solid var(--border-color);
            background: var(--surface-strong);
            flex: 1;
            min-height: 44px;
        }

        .input-toolbar textarea {
            flex: 1;
        }

        .input-panel .input-shell textarea {
            border: none;
            background: transparent;
            padding: 10px 4px;
            height: 44px;
            min-height: 44px;
            line-height: 1.4;
            resize: none;
            overflow-y: auto;
            text-align: left;
        }

        .input-panel .input-shell textarea:focus {
            outline: none;
        }

        .input-panel .input-shell textarea::placeholder {
            color: var(--text-secondary);
        }

        .file-btn {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .input-shell .send-btn {
            width: 44px;
            height: 44px;
            border-radius: 14px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .file-btn:hover,
        .input-shell .send-btn:hover {
            background: rgba(148, 163, 184, 0.16);
            color: var(--text-primary);
        }

        .file-chip {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 8px 10px;
            border-radius: 12px;
            border: 1px dashed var(--border-color);
            background: var(--surface-muted);
            font-size: 0.82rem;
            color: var(--text-secondary);
        }

        .file-chip strong {
            color: var(--text-primary);
        }

        .file-clear {
            border: none;
            background: transparent;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .input-panel textarea,
        .input-panel input,
        .input-panel select {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            font-size: 0.9rem;
            background: var(--surface-strong);
            color: var(--text-primary);
        }

        .input-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .input-actions .send-btn {
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .status {
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            display: none;
        }

        .status.success {
            display: block;
            background: rgba(22, 163, 74, 0.12);
            color: var(--success);
        }

        .status.error {
            display: block;
            background: rgba(220, 38, 38, 0.12);
            color: var(--error);
        }

        .status.progress {
            display: block;
            background: rgba(37, 99, 235, 0.12);
            color: var(--info);
        }

        .loader-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, #f8fafc 0%, #e2e8f0 45%, #f1f5f9 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader-card {
            width: min(520px, 85vw);
            padding: 30px;
            border-radius: 28px;
            background: rgba(255, 255, 255, 0.72);
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .loader-progress {
            margin-top: 18px;
            height: 6px;
            border-radius: 10px;
            background: rgba(148, 163, 184, 0.3);
            overflow: hidden;
        }

        .loader-progress span {
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #334155, #64748b, #94a3b8);
            transition: width 0.25s ease;
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .modal {
            width: min(520px, 90vw);
            background: var(--surface-strong);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .modal h3 {
            margin-bottom: 12px;
        }

        .modal-actions {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-actions button {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--primary-color);
            color: #fff;
        }

        .compare-panel {
            flex: 1;
            border-radius: 14px;
            padding: 14px;
            background: var(--surface-muted);
            border: 1px solid var(--border-color);
        }

        .compare-inline {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        .diff-add {
            background: rgba(34, 197, 94, 0.2);
            border-radius: 6px;
            padding: 0 3px;
        }

        .diff-remove {
            background: rgba(239, 68, 68, 0.15);
            border-radius: 6px;
            padding: 0 3px;
        }

        #reviewResultContent {
            max-height: 60vh;
            overflow-y: auto;
            padding-right: 6px;
            overflow-wrap: anywhere;
            word-break: break-word;
        }

        @media (max-width: 960px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .main-panel {
                order: 1;
            }

            .top-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .brand-row {
                width: 100%;
                align-items: flex-start;
            }

            .brand-row .model-input {
                width: 100%;
            }

            .message {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="loader-overlay" id="loader">
        <div class="loader-card">
            <h2>AI 翻译与译审对话系统</h2>
            <p style="margin-top: 6px; color: var(--text-secondary);">统一对话翻译流程</p>
            <div class="loader-progress"><span></span></div>
        </div>
    </div>

    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal">
            <h3>输入 API Key</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">仅首次使用需要输入，可在设置中清除缓存。</p>
            <input type="password" id="apiKeyInput" placeholder="sk-..." style="width: 100%; margin-top: 12px;">
            <div class="modal-actions">
                <button class="btn-secondary" id="apiKeyClear">清除</button>
                <button class="btn-primary" id="apiKeySave">保存</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="compareModal">
        <div class="modal" style="width: min(800px, 95vw);">
            <h3>更换模型生成对比</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">将使用相同提示重新生成结果，并替换当前输出。</p>
            <input type="text" id="compareModelInput" placeholder="例如：openai/gpt-4o" style="width: 100%; margin-top: 12px;">
            <div class="modal-actions">
                <button class="btn-secondary" id="compareClose">关闭</button>
                <button class="btn-primary" id="compareRun">生成并替换</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reviewModal">
        <div class="modal" style="width: min(520px, 90vw);">
            <h3>译审模型</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">输入用于本次译审的模型名称。</p>
            <input type="text" id="reviewModelInput" placeholder="例如：openai/gpt-4o" style="width: 100%; margin-top: 12px;">
            <div class="modal-actions">
                <button class="btn-secondary" id="reviewClose">取消</button>
                <button class="btn-primary" id="reviewRun">开始译审</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reviewResultModal">
        <div class="modal" style="width: min(860px, 92vw);">
            <h3>译审结果</h3>
            <div id="reviewResultContent" style="margin-top: 12px;"></div>
            <div class="modal-actions">
                <button class="btn-primary" id="reviewResultClose">关闭</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="docNotesModal">
        <div class="modal" style="width: min(560px, 92vw);">
            <h3>文档翻译补充说明</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">仅对本次文档翻译生效。</p>
            <textarea id="docNotesInput" rows="4" placeholder="可填写目标语言、用途、风格、格式要求等" style="width: 100%; margin-top: 12px;"></textarea>
            <div class="modal-actions">
                <button class="btn-secondary" id="docNotesCancel">取消</button>
                <button class="btn-primary" id="docNotesConfirm">开始翻译</button>
            </div>
        </div>
    </div>

    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">CHAT</div>
                <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>
            </div>
            <button class="new-chat-btn" id="newChatBtn"><i class="fas fa-plus"></i> <span>新建对话</span></button>
            <div class="history-list" id="historyList"></div>
            <div class="sidebar-footer">
                <button class="api-key-entry" id="apiKeyEntry" title="API Key" aria-label="API Key">
                    <i class="fas fa-key"></i>
                </button>
                <button class="review-entry" id="reviewRecordsEntry">
                    <i class="fas fa-clipboard-check"></i>
                    <span>译审记录</span>
                </button>
            </div>
        </aside>

        <main class="main-panel">
            <div class="top-bar">
                <div class="brand">
                    <div class="brand-row">
                        <span class="model-label">模型名称</span>
                        <input class="model-input" id="modelInput" type="text" placeholder="模型名称（OpenRouter）" list="modelHistoryList">
                        <datalist id="modelHistoryList"></datalist>
                    </div>
                </div>
            </div>

            <section class="chat-area">
                <div class="messages" id="messages"></div>
                <div class="status" id="statusBox"></div>
                <div class="input-panel" id="inputPanel"></div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const loader = document.getElementById('loader');
        const loaderProgress = document.querySelector('#loader .loader-progress span');
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeySave = document.getElementById('apiKeySave');
        const apiKeyClear = document.getElementById('apiKeyClear');
        const apiKeyEntry = document.getElementById('apiKeyEntry');
        const compareModal = document.getElementById('compareModal');
        const compareModelInput = document.getElementById('compareModelInput');
        const compareRun = document.getElementById('compareRun');
        const compareClose = document.getElementById('compareClose');
        const reviewModal = document.getElementById('reviewModal');
        const reviewModelInput = document.getElementById('reviewModelInput');
        const reviewRun = document.getElementById('reviewRun');
        const reviewClose = document.getElementById('reviewClose');
        const reviewResultModal = document.getElementById('reviewResultModal');
        const reviewResultContent = document.getElementById('reviewResultContent');
        const reviewResultClose = document.getElementById('reviewResultClose');
        const docNotesModal = document.getElementById('docNotesModal');
        const docNotesInput = document.getElementById('docNotesInput');
        const docNotesConfirm = document.getElementById('docNotesConfirm');
        const docNotesCancel = document.getElementById('docNotesCancel');
        const modelInput = document.getElementById('modelInput');
        const messagesEl = document.getElementById('messages');
        const inputPanel = document.getElementById('inputPanel');
        const statusBox = document.getElementById('statusBox');
        const historyList = document.getElementById('historyList');
        const newChatBtn = document.getElementById('newChatBtn');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const reviewRecordsEntry = document.getElementById('reviewRecordsEntry');

        const STORAGE_API_KEY = 'globalApiKey';
        const STORAGE_CONVERSATIONS = 'chatConversations';
        const STORAGE_ACTIVE = 'activeConversationId';
        const STORAGE_REVIEWS = 'reviewRecords';
        const STORAGE_MODEL_HISTORY = 'modelHistory';
        const DEFAULT_PREFS = {
            sourceLang: 'auto',
            targetLang: '中文',
            styleNotes: ''
        };

        const LANGUAGE_ALIASES = {
            中文: ['中文', '汉语', '汉文', '简体中文', '繁体中文'],
            英文: ['英文', '英语'],
            日文: ['日文', '日语'],
            韩文: ['韩文', '韩语'],
            俄文: ['俄文', '俄语'],
            德文: ['德文', '德语'],
            法文: ['法文', '法语'],
            西班牙文: ['西班牙文', '西班牙语'],
            葡萄牙文: ['葡萄牙文', '葡萄牙语'],
            意大利文: ['意大利文', '意大利语']
        };

        const SHORT_LANG_MAP = {
            中: '中文',
            英: '英文',
            日: '日文',
            韩: '韩文',
            俄: '俄文',
            德: '德文',
            法: '法文',
            西: '西班牙文',
            葡: '葡萄牙文',
            意: '意大利文'
        };

        const HISTORY_LABEL = '自动识别';

        let conversations = [];
        let activeConversationId = null;
        let compareContext = null;
        let reviewContext = null;
        let reviewRecords = [];
        let activeView = 'conversation';
        let pendingDocFileInput = null;
        let modelHistory = [];

        function ensureConversationDefaults(conversation) {
            if (!conversation.mode) {
                conversation.mode = 'auto';
            }
            if (!['auto', 'interactive', 'document'].includes(conversation.mode)) {
                conversation.mode = 'auto';
            }
            if (!conversation.model) {
                conversation.model = '';
            }
            if (!conversation.messages) {
                conversation.messages = [];
            }
            if (!conversation.translationPrefs) {
                conversation.translationPrefs = { ...DEFAULT_PREFS };
            } else {
                conversation.translationPrefs = {
                    ...DEFAULT_PREFS,
                    ...conversation.translationPrefs
                };
            }
        }

        function normalizeLanguage(raw) {
            if (!raw) return '';
            const trimmed = raw.trim();
            for (const [lang, aliases] of Object.entries(LANGUAGE_ALIASES)) {
                if (aliases.includes(trimmed)) {
                    return lang;
                }
            }
            return trimmed;
        }

        function normalizeQuotes(text) {
            if (!text) return '';
            return text
                .replace(/[“”「」『』]/g, '"')
                .replace(/[‘’]/g, "'");
        }

        function extractLanguagePrefs(text) {
            const langPattern = '(中文|英文|日文|韩文|俄文|德文|法文|西班牙文|葡萄牙文|意大利文|汉语|英语|日语|韩语|俄语|德语|法语|西班牙语|葡萄牙语|意大利语|简体中文|繁体中文)';
            const fromToRegex = new RegExp(`从${langPattern}(?:翻译|译)(?:成|为|到|至)${langPattern}`);
            const directRegex = new RegExp(`${langPattern}(?:翻译|译)(?:成|为|到|至)${langPattern}`);
            const toRegex = new RegExp(`(?:翻译|译|改)(?:为|成)${langPattern}`);
            const arrowRegex = new RegExp(`${langPattern}(?:到|至|->|→)${langPattern}`);
            const shortRegex = /([中英日韩俄德法西葡意])译([中英日韩俄德法西葡意])/;

            let sourceLang = '';
            let targetLang = '';

            const fromToMatch = text.match(fromToRegex);
            if (fromToMatch) {
                sourceLang = normalizeLanguage(fromToMatch[1]);
                targetLang = normalizeLanguage(fromToMatch[2]);
                return { sourceLang, targetLang };
            }

            const directMatch = text.match(directRegex);
            if (directMatch) {
                sourceLang = normalizeLanguage(directMatch[1]);
                targetLang = normalizeLanguage(directMatch[2]);
                return { sourceLang, targetLang };
            }

            const arrowMatch = text.match(arrowRegex);
            if (arrowMatch) {
                sourceLang = normalizeLanguage(arrowMatch[1]);
                targetLang = normalizeLanguage(arrowMatch[2]);
                return { sourceLang, targetLang };
            }

            const shortMatch = text.match(shortRegex);
            if (shortMatch) {
                sourceLang = SHORT_LANG_MAP[shortMatch[1]] || '';
                targetLang = SHORT_LANG_MAP[shortMatch[2]] || '';
                return { sourceLang, targetLang };
            }

            const toMatch = text.match(toRegex);
            if (toMatch) {
                targetLang = normalizeLanguage(toMatch[1]);
            }

            return { sourceLang, targetLang };
        }

        function extractStyleNotes(text) {
            const lines = text.split(/\n+/);
            const notes = [];
            lines.forEach(line => {
                const match = line.match(/^(风格|语气|术语|格式|要求|说明)[:：]\s*(.+)$/);
                if (match) {
                    notes.push(match[2].trim());
                }
            });

            const inlineMatch = text.match(/(?:请|保持|使用|采用)([^。！？\n]{1,20})(?:风格|语气|文风|语调|口吻)/);
            if (inlineMatch) {
                notes.push(`${inlineMatch[1].trim()}风格`);
            }

            return notes.filter(Boolean).join('；');
        }

        function updateConversationPrefs(conversation, text) {
            if (!conversation || !text) return;
            const languagePrefs = extractLanguagePrefs(text);
            if (languagePrefs.sourceLang) {
                conversation.translationPrefs.sourceLang = languagePrefs.sourceLang;
            }
            if (languagePrefs.targetLang) {
                conversation.translationPrefs.targetLang = languagePrefs.targetLang;
            }
            const styleNotes = extractStyleNotes(text);
            if (styleNotes) {
                conversation.translationPrefs.styleNotes = styleNotes;
            }
        }

        function buildSystemPrompt(prefs) {
            if (!prefs || !prefs.styleNotes) {
                return '';
            }
            const sourceLabel = prefs.sourceLang === 'auto' ? '自动检测语言' : (prefs.sourceLang || '源语言');
            const targetLabel = prefs.targetLang || '目标语言';
            return (
                `你是一个专业翻译，擅长从${sourceLabel}到${targetLabel}的翻译。` +
                `请保持原文语气、风格一致。\n补充要求：${prefs.styleNotes}`
            );
        }

        function loadState() {
            const storedConversations = localStorage.getItem(STORAGE_CONVERSATIONS);
            if (storedConversations) {
                try {
                    conversations = JSON.parse(storedConversations);
                } catch (error) {
                    conversations = [];
                }
            }
            const storedReviews = localStorage.getItem(STORAGE_REVIEWS);
            if (storedReviews) {
                try {
                    reviewRecords = JSON.parse(storedReviews);
                } catch (error) {
                    reviewRecords = [];
                }
            }
            const storedModels = localStorage.getItem(STORAGE_MODEL_HISTORY);
            if (storedModels) {
                try {
                    modelHistory = JSON.parse(storedModels);
                } catch (error) {
                    modelHistory = [];
                }
            }
            if (!modelHistory.length && Array.isArray(conversations)) {
                const seeded = conversations.map(conv => (conv.model || '').trim()).filter(Boolean);
                modelHistory = Array.from(new Set(seeded)).slice(0, 12);
            }
            conversations.forEach(ensureConversationDefaults);
            if (conversations.length === 0) {
                createConversation();
            } else {
                activeConversationId = localStorage.getItem(STORAGE_ACTIVE) || conversations[0].id;
            }
        }

        function saveState() {
            localStorage.setItem(STORAGE_CONVERSATIONS, JSON.stringify(conversations));
            localStorage.setItem(STORAGE_REVIEWS, JSON.stringify(reviewRecords));
            if (activeConversationId) {
                localStorage.setItem(STORAGE_ACTIVE, activeConversationId);
            }
        }

        function saveModelHistory() {
            localStorage.setItem(STORAGE_MODEL_HISTORY, JSON.stringify(modelHistory));
        }

        function renderModelHistory() {
            const dataList = document.getElementById('modelHistoryList');
            if (!dataList) return;
            dataList.innerHTML = '';
            modelHistory.forEach(modelName => {
                const option = document.createElement('option');
                option.value = modelName;
                dataList.appendChild(option);
            });
        }

        function addModelToHistory(modelName) {
            const normalized = (modelName || '').trim();
            if (!normalized) return;
            modelHistory = modelHistory.filter(item => item !== normalized);
            modelHistory.unshift(normalized);
            modelHistory = modelHistory.slice(0, 12);
            saveModelHistory();
            renderModelHistory();
        }

        function createConversation() {
            const id = `conv_${Date.now()}`;
            const conversation = {
                id,
                title: '新对话',
                mode: 'auto',
                model: '',
                messages: [],
                translationPrefs: { ...DEFAULT_PREFS }
            };
            conversations.unshift(conversation);
            activeConversationId = id;
            activeView = 'conversation';
            saveState();
            renderHistory();
            renderConversation();
        }

        function getActiveConversation() {
            return conversations.find(conv => conv.id === activeConversationId);
        }

        function renderHistory() {
            historyList.innerHTML = '';
            conversations.forEach(conv => {
                const item = document.createElement('div');
                const isActive = activeView === 'conversation' && conv.id === activeConversationId;
                item.className = 'history-item' + (isActive ? ' active' : '');
                item.innerHTML = `
                    <div class="history-row">
                        <div class="history-title">${conv.title}</div>
                        <div class="history-actions">
                            <button class="history-action-btn history-rename" title="重命名" aria-label="重命名">
                                <i class="fas fa-pen"></i>
                            </button>
                            <button class="history-action-btn history-delete" title="删除" aria-label="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="history-meta">${HISTORY_LABEL}</div>
                `;
                item.addEventListener('click', () => {
                    activeConversationId = conv.id;
                    activeView = 'conversation';
                    saveState();
                    renderHistory();
                    renderConversation();
                });
                const renameBtn = item.querySelector('.history-rename');
                const deleteBtn = item.querySelector('.history-delete');
                if (renameBtn) {
                    renameBtn.addEventListener('click', event => {
                        event.stopPropagation();
                        beginRename(item, conv);
                    });
                }
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', event => {
                        event.stopPropagation();
                        deleteConversation(conv.id);
                    });
                }
                historyList.appendChild(item);
            });
            reviewRecordsEntry.classList.toggle('active', activeView === 'reviewRecords');
        }

        function beginRename(item, conversation) {
            const titleEl = item.querySelector('.history-title');
            if (!titleEl) return;
            const input = document.createElement('input');
            input.type = 'text';
            input.value = conversation.title || '';
            input.className = 'history-title-input';
            titleEl.replaceWith(input);
            input.focus();
            input.select();

            const finish = commit => {
                const nextTitle = commit ? input.value.trim() : conversation.title;
                if (commit && nextTitle) {
                    conversation.title = nextTitle;
                }
                saveState();
                renderHistory();
            };

            input.addEventListener('click', event => event.stopPropagation());
            input.addEventListener('keydown', event => {
                if (event.key === 'Enter') {
                    finish(true);
                }
                if (event.key === 'Escape') {
                    finish(false);
                }
            });
            input.addEventListener('blur', () => finish(true));
        }

        function deleteConversation(conversationId) {
            const index = conversations.findIndex(conv => conv.id === conversationId);
            if (index === -1) return;
            if (!confirm('确认删除该对话？')) return;
            const wasActive = activeConversationId === conversationId;
            conversations.splice(index, 1);
            if (!conversations.length) {
                createConversation();
                return;
            }
            if (wasActive) {
                activeConversationId = conversations[0].id;
            }
            saveState();
            renderHistory();
            renderConversation();
        }

        function renderConversation(options = {}) {
            if (activeView === 'reviewRecords') {
                renderReviewRecords();
                return;
            }
            const preserveScroll = options && options.preserveScroll;
            const priorScrollTop = preserveScroll ? messagesEl.scrollTop : 0;
            const conversation = getActiveConversation();
            if (!conversation) return;
            ensureConversationDefaults(conversation);
            modelInput.value = conversation.model || '';
            messagesEl.innerHTML = '';
            conversation.messages.forEach(message => {
                messagesEl.appendChild(renderMessage(message));
            });
            renderInputPanel();
            if (preserveScroll) {
                const maxScroll = Math.max(0, messagesEl.scrollHeight - messagesEl.clientHeight);
                messagesEl.scrollTop = Math.min(priorScrollTop, maxScroll);
            } else {
                messagesEl.scrollTop = messagesEl.scrollHeight;
            }
        }

        function renderReviewRecords() {
            messagesEl.innerHTML = '';
            inputPanel.innerHTML = '';
            showStatus('', '');

            const header = document.createElement('div');
            header.className = 'review-record-title';
            header.textContent = '译审记录';
            messagesEl.appendChild(header);

            if (!reviewRecords.length) {
                const empty = document.createElement('div');
                empty.className = 'review-record-empty';
                empty.textContent = '暂无译审记录。';
                messagesEl.appendChild(empty);
                return;
            }

            reviewRecords.forEach(record => {
                const item = document.createElement('div');
                item.className = 'review-record';

                const timeLabel = record.timestamp ? new Date(record.timestamp).toLocaleString() : '';
                const modelLabel = record.reviewModel || '未标注';
                const translationModels = (record.translations || []).map(t => t.model).filter(Boolean).join('、');

                item.innerHTML = `
                    <div class="review-record-meta">${timeLabel} · 译审模型：${modelLabel}${translationModels ? ` · 译文模型：${translationModels}` : ''}</div>
                    <div class="review-record-title">原文</div>
                    <div>${marked.parse(normalizeQuotes(record.sourceText || ''))}</div>
                    <div class="review-record-title" style="margin-top: 10px;">译审报告</div>
                    <div>${marked.parse(normalizeQuotes(record.report || ''))}</div>
                `;

                messagesEl.appendChild(item);
            });
        }

        function resolveCompareIndex(message) {
            const history = Array.isArray(message.compareHistory) ? message.compareHistory : [];
            if (!history.length) return -1;
            let index = Number.isInteger(message.activeCompareIndex) ? message.activeCompareIndex : -1;
            if (index < 0 || index >= history.length) {
                const byModel = history.findIndex(item => item.model === message.model);
                index = byModel >= 0 ? byModel : history.length - 1;
            }
            return index;
        }

        function renderMessage(message) {
            const wrapper = document.createElement('div');
            wrapper.className = `message ${message.role}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            const compareHistory = Array.isArray(message.compareHistory) ? message.compareHistory : [];
            const compareIndex = resolveCompareIndex(message);
            const displayEntry = compareIndex >= 0 ? compareHistory[compareIndex] : null;
            const displayContent = displayEntry && displayEntry.output ? displayEntry.output : (message.content || '');
            const displayModel = displayEntry && displayEntry.model ? displayEntry.model : (message.model || '未标注');
            const safeContent = normalizeQuotes(displayContent);
            bubble.innerHTML = marked.parse(safeContent);

            wrapper.appendChild(bubble);

            if (message.role === 'assistant') {
                const footer = document.createElement('div');
                footer.className = 'message-footer';
                const source = document.createElement('div');
                source.className = 'message-source';
                source.textContent = `模型：${displayModel}`;
                footer.appendChild(source);

                if (message.comparePayload) {
                    const actions = document.createElement('div');
                    actions.className = 'message-actions';

                    if (compareHistory.length > 1) {
                        const nav = document.createElement('div');
                        nav.className = 'compare-nav';

                        const prevBtn = document.createElement('button');
                        prevBtn.className = 'compare-icon-btn';
                        prevBtn.title = '上一个结果';
                        prevBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                        prevBtn.addEventListener('click', () => {
                            const nextIndex = (resolveCompareIndex(message) - 1 + compareHistory.length) % compareHistory.length;
                            message.activeCompareIndex = nextIndex;
                            saveState();
                            renderConversation({ preserveScroll: true });
                        });
                        nav.appendChild(prevBtn);

                        const indexLabel = document.createElement('span');
                        indexLabel.className = 'compare-index';
                        indexLabel.textContent = `${compareIndex + 1}/${compareHistory.length}`;
                        nav.appendChild(indexLabel);

                        const nextBtn = document.createElement('button');
                        nextBtn.className = 'compare-icon-btn';
                        nextBtn.title = '下一个结果';
                        nextBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                        nextBtn.addEventListener('click', () => {
                            const nextIndex = (resolveCompareIndex(message) + 1) % compareHistory.length;
                            message.activeCompareIndex = nextIndex;
                            saveState();
                            renderConversation({ preserveScroll: true });
                        });
                        nav.appendChild(nextBtn);

                        actions.appendChild(nav);
                    }

                    const reviewButton = document.createElement('button');
                    reviewButton.className = 'compare-btn';
                    reviewButton.innerHTML = '<i class="fas fa-clipboard-check"></i> 译审';
                    reviewButton.addEventListener('click', () => openReviewModal(message));
                    actions.appendChild(reviewButton);

                    const switchButton = document.createElement('button');
                    switchButton.className = 'compare-btn';
                    switchButton.innerHTML = '<i class="fas fa-retweet"></i> 更换模型';
                    switchButton.addEventListener('click', () => openCompareModal(message));
                    actions.appendChild(switchButton);

                    if (compareHistory.length > 1) {
                        const compareButton = document.createElement('button');
                        compareButton.className = 'compare-btn';
                        compareButton.innerHTML = message.compareExpanded
                            ? '<i class="fas fa-clone"></i> 收起'
                            : '<i class="fas fa-clone"></i> 全部显示';
                        compareButton.addEventListener('click', () => toggleCompareView(message));
                        actions.appendChild(compareButton);
                    }

                    footer.appendChild(actions);
                }

                wrapper.appendChild(footer);

                if (compareHistory.length > 1 && message.compareExpanded) {
                    const compareInline = document.createElement('div');
                    compareInline.className = 'compare-inline';
                    compareHistory.forEach(item => {
                        const panel = document.createElement('div');
                        panel.className = 'compare-panel';
                        panel.innerHTML = `
                            <h4>${item.model}</h4>
                            <div>${marked.parse(normalizeQuotes(item.output || ''))}</div>
                        `;
                        compareInline.appendChild(panel);
                    });
                    wrapper.appendChild(compareInline);
                }
            }

            return wrapper;
        }

        const BASE_INPUT_HEIGHT = 44;

        function getChatInputMaxHeight() {
            const chatArea = document.querySelector('.chat-area');
            if (!chatArea) return 160;
            return Math.max(BASE_INPUT_HEIGHT, Math.floor(chatArea.clientHeight * 0.25));
        }

        function adjustChatInputHeight(textarea) {
            if (!textarea) return;
            const maxHeight = getChatInputMaxHeight();
            const baseHeight = BASE_INPUT_HEIGHT;
            textarea.style.height = 'auto';
            const scrollHeight = textarea.scrollHeight;
            const nextHeight = Math.max(baseHeight, Math.min(scrollHeight, maxHeight));
            textarea.style.height = `${nextHeight}px`;
            textarea.style.overflowY = scrollHeight > maxHeight ? 'auto' : 'hidden';
        }

        function resetChatInputHeight(textarea) {
            if (!textarea) return;
            textarea.style.height = `${BASE_INPUT_HEIGHT}px`;
            textarea.style.overflowY = 'hidden';
        }

        function renderInputPanel() {
            inputPanel.innerHTML = '';
            showStatus('', '');
            inputPanel.innerHTML = `
                <div class="input-toolbar">
                    <div class="input-shell">
                        <button class="file-btn" id="fileBtn" title="选择文档" aria-label="选择文档">
                            <i class="fas fa-paperclip"></i>
                        </button>
                        <textarea id="chatInput" rows="1" placeholder="请输入..."></textarea>
                        <input type="file" id="docFile" accept=".txt,.doc,.docx" hidden />
                        <button class="send-btn" id="sendBtn" title="发送" aria-label="发送">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
                <div class="file-chip" id="fileChip" style="display: none;">
                    <span>已选择：<strong id="fileName"></strong></span>
                    <button class="file-clear" id="fileClear" title="移除文件" aria-label="移除文件">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;
            const fileBtn = document.getElementById('fileBtn');
            const fileInput = document.getElementById('docFile');
            const fileChip = document.getElementById('fileChip');
            const fileName = document.getElementById('fileName');
            const fileClear = document.getElementById('fileClear');
            const chatInput = document.getElementById('chatInput');

            const updateFileChip = file => {
                if (file) {
                    fileName.textContent = file.name;
                    fileChip.style.display = 'flex';
                } else {
                    fileName.textContent = '';
                    fileChip.style.display = 'none';
                }
            };

            fileBtn.addEventListener('click', () => fileInput.click());
            fileInput.addEventListener('change', () => {
                const file = fileInput.files && fileInput.files[0] ? fileInput.files[0] : null;
                updateFileChip(file);
            });
            fileClear.addEventListener('click', () => {
                fileInput.value = '';
                updateFileChip(null);
            });

            if (chatInput) {
                resetChatInputHeight(chatInput);
                adjustChatInputHeight(chatInput);
                chatInput.addEventListener('input', () => adjustChatInputHeight(chatInput));
            }

            document.getElementById('sendBtn').addEventListener('click', handleUnifiedSend);
        }

        function updateConversationTitle(conversation, text) {
            if (conversation.title !== '新对话') return;
            const trimmed = text.trim();
            if (trimmed) {
                conversation.title = trimmed.slice(0, 12);
            }
        }

        function appendMessage(conversation, message) {
            conversation.messages.push(message);
            messagesEl.appendChild(renderMessage(message));
            messagesEl.scrollTop = messagesEl.scrollHeight;
            saveState();
            renderHistory();
        }

        function showStatus(message, type) {
            if (!message) {
                statusBox.textContent = '';
                statusBox.className = 'status';
                return;
            }
            statusBox.textContent = message;
            statusBox.className = `status ${type}`;
        }

        let statusTimer = null;

        function startStatusSequence(steps) {
            if (!steps || steps.length === 0) return;
            if (statusTimer) {
                clearInterval(statusTimer);
            }
            let index = 0;
            showStatus(steps[index], 'progress');
            statusTimer = setInterval(() => {
                index = (index + 1) % steps.length;
                showStatus(steps[index], 'progress');
            }, 1600);
        }

        function playStatusSteps(steps, finalMessage, finalType) {
            return new Promise(resolve => {
                if (statusTimer) {
                    clearInterval(statusTimer);
                    statusTimer = null;
                }
                if (!steps || steps.length === 0) {
                    stopStatusSequence(finalMessage, finalType);
                    resolve();
                    return;
                }
                let index = 0;
                showStatus(steps[index], 'progress');
                statusTimer = setInterval(() => {
                    index += 1;
                    if (index >= steps.length) {
                        clearInterval(statusTimer);
                        statusTimer = null;
                        stopStatusSequence(finalMessage, finalType);
                        resolve();
                        return;
                    }
                    showStatus(steps[index], 'progress');
                }, 900);
            });
        }

        function stopStatusSequence(message, type) {
            if (statusTimer) {
                clearInterval(statusTimer);
                statusTimer = null;
            }
            showStatus(message, type);
        }

        async function handleUnifiedSend() {
            const fileInput = document.getElementById('docFile');
            const chatInput = document.getElementById('chatInput');
            const file = fileInput && fileInput.files ? fileInput.files[0] : null;
            const draftNotes = chatInput ? chatInput.value.trim() : '';

            if (file) {
                openDocNotesModal(fileInput, draftNotes);
                return;
            }

            const text = chatInput ? chatInput.value.trim() : '';
            if (!text) {
                showStatus('请输入文本或上传文档。', 'error');
                return;
            }
            await handleInteractiveSend(text);
        }

        async function handleInteractiveSend(text) {
            const conversation = getActiveConversation();
            if (!text) return;
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }
            if (!conversation.model) {
                showStatus('请先输入模型名称。', 'error');
                return;
            }

            updateConversationPrefs(conversation, text);
            const prefs = conversation.translationPrefs || { ...DEFAULT_PREFS };
            const systemPrompt = buildSystemPrompt(prefs);

            updateConversationTitle(conversation, text);
            appendMessage(conversation, { role: 'user', content: text });
            const input = document.getElementById('chatInput');
            if (input) {
                input.value = '';
                resetChatInputHeight(input);
            }

            const compareFallback = compareContext && compareContext.comparePayload && compareContext.comparePayload.mode === 'review'
                ? '正在译审'
                : '正在翻译';
            startStatusSequence([compareFallback]);
            try {
                const response = await fetch('/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_message: text,
                        api_key: apiKey,
                        model: conversation.model,
                        temperature: 1.0,
                        source_lang: prefs.sourceLang || 'auto',
                        target_lang: prefs.targetLang || '中文',
                        system_prompt: systemPrompt
                    })
                });
                const result = await response.json();
                if (result.error) {
                    stopStatusSequence(result.error, 'error');
                    return;
                }
                appendMessage(conversation, {
                    role: 'assistant',
                    content: result.translation,
                    model: conversation.model,
                    comparePayload: {
                        mode: 'interactive',
                        baseOutput: result.translation,
                        inputText: text,
                        sourceLang: prefs.sourceLang || 'auto',
                        targetLang: prefs.targetLang || '中文',
                        systemPrompt
                    },
                    compareHistory: [
                        { model: conversation.model || '当前模型', output: result.translation }
                    ],
                    compareExpanded: false
                });
                const statusSteps = Array.isArray(result.status_steps) ? result.status_steps.filter(Boolean) : [];
                if (statusSteps.length) {
                    await playStatusSteps(statusSteps, '完成', 'success');
                } else {
                    stopStatusSequence('完成', 'success');
                }
                saveState();
            } catch (error) {
                stopStatusSequence('请求失败，请重试。', 'error');
            }
        }

        function deriveTempPrefs(basePrefs, text) {
            const prefs = { ...(basePrefs || DEFAULT_PREFS) };
            if (!text) return prefs;
            const languagePrefs = extractLanguagePrefs(text);
            if (languagePrefs.sourceLang) {
                prefs.sourceLang = languagePrefs.sourceLang;
            }
            if (languagePrefs.targetLang) {
                prefs.targetLang = languagePrefs.targetLang;
            }
            const styleNotes = extractStyleNotes(text);
            if (styleNotes) {
                prefs.styleNotes = styleNotes;
            }
            return prefs;
        }

        async function handleDocumentSend(file, notes, fileInput) {
            const conversation = getActiveConversation();
            if (!file) {
                showStatus('请先上传文档。', 'error');
                return;
            }
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }
            if (!conversation.model) {
                showStatus('请先输入模型名称。', 'error');
                return;
            }

            const noteText = notes || '';
            const prefs = deriveTempPrefs(conversation.translationPrefs || { ...DEFAULT_PREFS }, noteText);
            const userMessage = noteText ? `上传文档：${file.name}\n${noteText}` : `上传文档：${file.name}`;
            updateConversationTitle(conversation, file.name);
            appendMessage(conversation, { role: 'user', content: userMessage });
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.value = '';
                resetChatInputHeight(chatInput);
            }
            startStatusSequence(['正在翻译']);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('api_key', apiKey);
            formData.append('model', conversation.model);
            formData.append('temperature', '1.0');
            formData.append('source_lang', prefs.sourceLang || 'auto');
            formData.append('target_lang', prefs.targetLang || '中文');
            formData.append('system_prompt', noteText);
            formData.append('user_prompt', noteText);

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.error) {
                    stopStatusSequence(result.error, 'error');
                    return;
                }
                appendMessage(conversation, {
                    role: 'assistant',
                    content: `文档翻译完成，可下载：\n[下载链接](/download/${result.output_file})`,
                    model: conversation.model
                });
                stopStatusSequence('完成', 'success');
            } catch (error) {
                stopStatusSequence('上传失败，请重试。', 'error');
            } finally {
                if (fileInput) {
                    fileInput.value = '';
                }
                const fileChip = document.getElementById('fileChip');
                const fileName = document.getElementById('fileName');
                if (fileChip) {
                    fileChip.style.display = 'none';
                }
                if (fileName) {
                    fileName.textContent = '';
                }
            }
        }

        function openDocNotesModal(fileInput, draftText) {
            pendingDocFileInput = fileInput || null;
            if (docNotesInput) {
                docNotesInput.value = draftText || '';
            }
            docNotesModal.style.display = 'flex';
            setTimeout(() => {
                if (docNotesInput) {
                    docNotesInput.focus();
                }
            }, 0);
        }

        function closeDocNotesModal() {
            docNotesModal.style.display = 'none';
            pendingDocFileInput = null;
        }

        docNotesConfirm.addEventListener('click', async () => {
            const fileInput = pendingDocFileInput || document.getElementById('docFile');
            const file = fileInput && fileInput.files ? fileInput.files[0] : null;
            if (!file) {
                closeDocNotesModal();
                showStatus('请先选择文档。', 'error');
                return;
            }
            const noteText = docNotesInput ? docNotesInput.value.trim() : '';
            closeDocNotesModal();
            await handleDocumentSend(file, noteText, fileInput);
        });

        docNotesCancel.addEventListener('click', closeDocNotesModal);


        function openApiModal() {
            apiKeyModal.style.display = 'flex';
            const storedKey = localStorage.getItem(STORAGE_API_KEY) || '';
            apiKeyInput.value = storedKey;
            apiKeyClear.disabled = !storedKey;
        }

        function closeApiModal() {
            apiKeyModal.style.display = 'none';
        }

        apiKeySave.addEventListener('click', () => {
            const value = apiKeyInput.value.trim();
            if (value) {
                localStorage.setItem(STORAGE_API_KEY, value);
                closeApiModal();
                showStatus('API Key 已保存。', 'success');
            }
        });

        apiKeyClear.addEventListener('click', () => {
            localStorage.removeItem(STORAGE_API_KEY);
            apiKeyInput.value = '';
            apiKeyClear.disabled = true;
        });
        apiKeyEntry.addEventListener('click', openApiModal);

        function openCompareModal(message) {
            compareContext = message;
            compareModelInput.value = '';
            compareModal.style.display = 'flex';
        }

        function openReviewModal(message) {
            reviewContext = message;
            reviewModelInput.value = '';
            reviewModal.style.display = 'flex';
        }

        function closeReviewModal() {
            reviewModal.style.display = 'none';
            reviewContext = null;
        }

        compareClose.addEventListener('click', () => {
            compareModal.style.display = 'none';
            compareContext = null;
        });

        reviewClose.addEventListener('click', closeReviewModal);

        reviewResultClose.addEventListener('click', () => {
            reviewResultModal.style.display = 'none';
        });

        compareRun.addEventListener('click', async () => {
            if (!compareContext) return;
            const modelName = compareModelInput.value.trim();
            if (!modelName) return;
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }

            compareRun.disabled = true;
            startStatusSequence(['正在翻译']);
            try {
                let compareText = '';
                let compareStatusSteps = [];

                if (!compareContext.comparePayload) {
                    stopStatusSequence('无法对比：缺少上下文。', 'error');
                    compareRun.disabled = false;
                    return;
                }

                if (compareContext.comparePayload.mode === 'interactive') {
                    const response = await fetch('/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_message: compareContext.comparePayload.inputText,
                            api_key: apiKey,
                            model: modelName,
                            temperature: 1.0,
                            source_lang: compareContext.comparePayload.sourceLang,
                            target_lang: compareContext.comparePayload.targetLang,
                            system_prompt: compareContext.comparePayload.systemPrompt || ''
                        })
                    });
                    const result = await response.json();
                    if (result.error) {
                        stopStatusSequence(result.error, 'error');
                        return;
                    }
                    compareText = result.translation || '';
                    if (Array.isArray(result.status_steps)) {
                        compareStatusSteps = result.status_steps.filter(Boolean);
                    }
                }

                if (compareContext.comparePayload.mode === 'review') {
                    const response = await fetch('/review', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            mode: 'single',
                            source_text: compareContext.comparePayload.sourceText,
                            target_text: compareContext.comparePayload.targetText,
                            source_lang: compareContext.comparePayload.sourceLang,
                            target_lang: compareContext.comparePayload.targetLang,
                            config: { api_key: apiKey, model: modelName }
                        })
                    });
                    const result = await response.json();
                    if (result.error) {
                        stopStatusSequence(result.error, 'error');
                        return;
                    }
                    compareText = `评分：${result.score || 'N/A'}\n\n评估：\n${result.review || ''}\n\n建议：\n${result.suggestions || ''}`;
                    if (Array.isArray(result.status_steps)) {
                        compareStatusSteps = result.status_steps.filter(Boolean);
                    }
                }

                if (!compareText) {
                    stopStatusSequence('对比失败，请重试。', 'error');
                    compareRun.disabled = false;
                    return;
                }

                const history = compareContext.compareHistory || [];
                const currentModel = compareContext.model || '当前模型';
                if (!history.find(item => item.model === currentModel)) {
                    history.push({ model: currentModel, output: compareContext.content || '' });
                }

                const existing = history.find(item => item.model === modelName);
                if (existing) {
                    existing.output = compareText;
                } else {
                    history.push({ model: modelName, output: compareText });
                }

                compareContext.compareHistory = history;
                const nextIndex = history.findIndex(item => item.model === modelName);
                compareContext.activeCompareIndex = nextIndex >= 0 ? nextIndex : history.length - 1;
                compareContext.content = compareText;
                compareContext.model = modelName;
                compareContext.compareExpanded = false;

                saveState();
                renderConversation({ preserveScroll: true });
                compareModal.style.display = 'none';
                compareContext = null;
                if (compareStatusSteps.length) {
                    await playStatusSteps(compareStatusSteps, '对比结果已更新。', 'success');
                } else {
                    stopStatusSequence('对比结果已更新。', 'success');
                }
            } catch (error) {
                stopStatusSequence('对比失败，请重试。', 'error');
            } finally {
                compareRun.disabled = false;
            }
        });

        reviewRun.addEventListener('click', async () => {
            if (!reviewContext) return;
            const modelName = reviewModelInput.value.trim();
            if (!modelName) return;
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }

            const payload = reviewContext.comparePayload;
            if (!payload) {
                stopStatusSequence('无法译审：缺少上下文。', 'error');
                return;
            }

            const translations = Array.isArray(reviewContext.compareHistory) && reviewContext.compareHistory.length
                ? reviewContext.compareHistory.slice()
                : [{ model: reviewContext.model || '当前模型', output: reviewContext.content || '' }];

            const currentModel = reviewContext.model || '当前模型';
            if (!translations.find(item => item.model === currentModel)) {
                translations.push({ model: currentModel, output: reviewContext.content || '' });
            }

            const translationsSnapshot = translations.map(item => ({
                model: item.model,
                output: item.output
            }));

            reviewRun.disabled = true;
            startStatusSequence(['正在译审']);
            try {
                const response = await fetch('/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: 'multi',
                        source_text: payload.inputText,
                        source_lang: payload.sourceLang || 'auto',
                        target_lang: payload.targetLang || '中文',
                        translations: translationsSnapshot,
                        config: {
                            api_key: apiKey,
                            model: modelName
                        }
                    })
                });
                const result = await response.json();
                if (result.error) {
                    stopStatusSequence(result.error, 'error');
                    return;
                }

                const report = result.report || result.review || '';
                reviewResultContent.innerHTML = marked.parse(normalizeQuotes(report));
                reviewResultModal.style.display = 'flex';

                reviewRecords.unshift({
                    id: `review_${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    reviewModel: modelName,
                    sourceText: payload.inputText,
                    sourceLang: payload.sourceLang,
                    targetLang: payload.targetLang,
                    translations: translationsSnapshot,
                    report
                });
                saveState();
                const statusSteps = Array.isArray(result.status_steps) ? result.status_steps.filter(Boolean) : [];
                if (statusSteps.length) {
                    await playStatusSteps(statusSteps, '译审完成', 'success');
                } else {
                    stopStatusSequence('译审完成', 'success');
                }
                closeReviewModal();
            } catch (error) {
                stopStatusSequence('译审失败，请重试。', 'error');
            } finally {
                reviewRun.disabled = false;
            }
        });

        function toggleCompareView(message) {
            message.compareExpanded = !message.compareExpanded;
            saveState();
            renderConversation({ preserveScroll: true });
        }

        function commitModelInput() {
            const conversation = getActiveConversation();
            if (!conversation) return;
            const value = modelInput.value.trim();
            conversation.model = value;
            saveState();
            addModelToHistory(value);
        }

        modelInput.addEventListener('input', () => {
            const conversation = getActiveConversation();
            if (!conversation) return;
            conversation.model = modelInput.value.trim();
            saveState();
        });

        modelInput.addEventListener('change', commitModelInput);
        modelInput.addEventListener('blur', commitModelInput);
        modelInput.addEventListener('keydown', event => {
            if (event.key === 'Enter') {
                event.preventDefault();
                commitModelInput();
                modelInput.blur();
            }
        });

        newChatBtn.addEventListener('click', createConversation);

        reviewRecordsEntry.addEventListener('click', () => {
            activeView = 'reviewRecords';
            renderHistory();
            renderConversation();
        });

        sidebarToggle.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-collapsed');
        });

        function initLoader() {
            if (!loader || !loaderProgress) {
                return { markAppReady: () => {} };
            }

            const assets = Array.from(document.querySelectorAll('link[rel="stylesheet"], script[src]'));
            const totalSteps = assets.length + 1;
            let loadedSteps = 0;
            let finished = false;

            const setProgress = value => {
                const clamped = Math.min(1, Math.max(0, value));
                const visual = Math.max(0.08, clamped);
                loaderProgress.style.width = `${(visual * 100).toFixed(1)}%`;
            };

            const finishLoading = () => {
                if (finished) return;
                finished = true;
                setProgress(1);
                setTimeout(() => {
                    loader.style.display = 'none';
                    const storedKey = localStorage.getItem(STORAGE_API_KEY);
                    if (!storedKey) {
                        openApiModal();
                    }
                }, 150);
            };

            const markLoaded = () => {
                loadedSteps = Math.min(loadedSteps + 1, totalSteps);
                setProgress(loadedSteps / totalSteps);
                if (loadedSteps >= totalSteps) {
                    finishLoading();
                }
            };

            const assetLoaded = asset => {
                const resourceLoaded = url => {
                    if (!url || !window.performance || !performance.getEntriesByName) {
                        return false;
                    }
                    return performance.getEntriesByName(url).length > 0;
                };
                if (asset.tagName === 'LINK') {
                    return Boolean(asset.sheet) || resourceLoaded(asset.href);
                }
                if (asset.tagName === 'SCRIPT') {
                    return asset.readyState === 'complete' || asset.readyState === 'loaded' || asset.dataset.loaded === 'true' || resourceLoaded(asset.src);
                }
                return false;
            };

            setProgress(0);
            assets.forEach(asset => {
                const markOnce = () => {
                    if (asset.dataset.loaded === 'true') {
                        return;
                    }
                    asset.dataset.loaded = 'true';
                    markLoaded();
                };
                if (assetLoaded(asset)) {
                    markOnce();
                } else {
                    asset.addEventListener('load', markOnce, { once: true });
                    asset.addEventListener('error', markOnce, { once: true });
                }
            });

            return { markAppReady: markLoaded };
        }

        const loaderTracker = initLoader();
        loadState();
        renderModelHistory();
        renderHistory();
        renderConversation();
        loaderTracker.markAppReady();
    </script>
</body>
</html>
