<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 翻译与译审对话系统（Chat-based）</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary-color: #3f4652;
            --primary-hover: #2f3540;
            --surface: rgba(255, 255, 255, 0.78);
            --surface-strong: rgba(255, 255, 255, 0.92);
            --surface-muted: rgba(241, 245, 249, 0.85);
            --text-primary: #111827;
            --text-secondary: #6b7280;
            --border-color: rgba(148, 163, 184, 0.35);
            --shadow-lg: 0 24px 45px -30px rgba(15, 23, 42, 0.6);
            --shadow-md: 0 14px 30px -22px rgba(15, 23, 42, 0.4);
            --sidebar-bg: rgba(15, 23, 42, 0.92);
            --sidebar-text: #e2e8f0;
            --sidebar-muted: rgba(226, 232, 240, 0.6);
            --success: #16a34a;
            --error: #dc2626;
            --info: #2563eb;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "微软雅黑", "Segoe UI", Arial, sans-serif;
            background: radial-gradient(circle at top left, rgba(248, 250, 252, 0.9), rgba(226, 232, 240, 0.6));
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
            overflow: hidden;
        }

        button,
        input,
        textarea,
        select {
            font-family: "Microsoft YaHei", "微软雅黑", "Segoe UI", Arial, sans-serif;
        }

        body::before {
            content: '';
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at 10% 20%, rgba(248, 250, 252, 0.9), transparent 55%),
                        radial-gradient(circle at 80% 0%, rgba(148, 163, 184, 0.18), transparent 40%),
                        radial-gradient(circle at 80% 80%, rgba(203, 213, 225, 0.25), transparent 45%);
            pointer-events: none;
            z-index: -1;
        }

        .app-shell {
            display: grid;
            grid-template-columns: 300px 1fr;
            min-height: 100vh;
            gap: 24px;
            padding: 24px;
            height: 100vh;
        }

        .sidebar {
            background: var(--sidebar-bg);
            border-radius: 24px;
            padding: 24px;
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: var(--shadow-lg);
            border: 1px solid rgba(148, 163, 184, 0.2);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .sidebar-title {
            font-size: 1rem;
            font-weight: 600;
            letter-spacing: 0.2em;
        }

        .sidebar-toggle {
            width: 36px;
            height: 36px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
            color: var(--sidebar-text);
            cursor: pointer;
        }

        .sidebar-collapsed .app-shell {
            grid-template-columns: 88px 1fr;
        }

        .sidebar-collapsed .sidebar-title,
        .sidebar-collapsed .history-title,
        .sidebar-collapsed .history-meta,
        .sidebar-collapsed .new-chat-btn span,
        .sidebar-collapsed .review-entry span {
            display: none;
        }

        .sidebar-collapsed .new-chat-btn {
            justify-content: center;
        }

        .sidebar-collapsed .review-entry {
            justify-content: center;
        }

        .new-chat-btn {
            width: 100%;
            padding: 12px 16px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.08);
            color: var(--sidebar-text);
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 8px;
        }

        .review-entry {
            width: 100%;
            padding: 10px 12px;
            border-radius: 12px;
            border: 1px dashed rgba(255, 255, 255, 0.18);
            background: rgba(255, 255, 255, 0.06);
            color: var(--sidebar-muted);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .review-entry.active {
            border-color: rgba(255, 255, 255, 0.4);
            color: var(--sidebar-text);
        }

        .history-item {
            padding: 12px 14px;
            border-radius: 14px;
            background: rgba(15, 23, 42, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.08);
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.08);
        }

        .history-item.active {
            border-color: rgba(255, 255, 255, 0.4);
            background: rgba(255, 255, 255, 0.12);
        }

        .history-title {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .history-meta {
            font-size: 0.75rem;
            color: var(--sidebar-muted);
        }

        .main-panel {
            display: flex;
            flex-direction: column;
            gap: 16px;
            min-height: 0;
        }

        .top-bar {
            background: var(--surface);
            border-radius: 20px;
            padding: 18px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
        }

        .brand {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .brand h1 {
            font-size: 1.4rem;
            font-weight: 700;
        }

        .brand span {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .control-group {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .mode-select,
        .model-input {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--surface-strong);
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .settings-btn {
            padding: 10px 14px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            background: var(--surface-strong);
            cursor: pointer;
            font-size: 0.9rem;
        }

        .chat-area {
            background: var(--surface);
            border-radius: 24px;
            padding: 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            box-shadow: var(--shadow-md);
            border: 1px solid var(--border-color);
            backdrop-filter: blur(16px);
            min-height: 60vh;
            min-height: 0;
        }

        .messages {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 18px;
            min-height: 0;
        }

        .message {
            display: block;
            max-width: 82%;
            padding: 12px 4px;
            border-bottom: 1px solid rgba(148, 163, 184, 0.18);
        }

        .message.user {
            align-self: flex-end;
            margin-left: 18%;
        }

        .message.assistant {
            align-self: flex-start;
            margin-right: 18%;
        }

        .message:last-child {
            border-bottom: none;
        }

        .message-bubble {
            background: transparent;
            border: none;
            border-radius: 0;
            padding: 0;
            font-size: 0.98rem;
        }

        .message-meta {
            font-size: 0.75rem;
            color: var(--text-secondary);
            margin-top: 6px;
        }

        .message-actions {
            display: flex;
            gap: 8px;
        }

        .compare-btn {
            border: none;
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-secondary);
            border-radius: 10px;
            padding: 6px 10px;
            cursor: pointer;
            font-size: 0.8rem;
        }

        .message-footer {
            margin-top: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }

        .message-source {
            font-size: 0.78rem;
            color: var(--text-secondary);
        }

        .review-record {
            background: var(--surface-strong);
            border: 1px solid var(--border-color);
            border-radius: 16px;
            padding: 14px 16px;
        }

        .review-record-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .review-record-title {
            font-weight: 600;
            margin-bottom: 6px;
        }

        .review-record-empty {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .input-panel {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .input-panel textarea,
        .input-panel input,
        .input-panel select {
            border-radius: 12px;
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            font-size: 0.9rem;
            background: var(--surface-strong);
            color: var(--text-primary);
        }

        .input-actions {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .send-btn {
            background: var(--primary-color);
            color: #fff;
            border: none;
            padding: 12px 20px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        .status {
            padding: 10px 12px;
            border-radius: 10px;
            font-size: 0.85rem;
            display: none;
        }

        .status.success {
            display: block;
            background: rgba(22, 163, 74, 0.12);
            color: var(--success);
        }

        .status.error {
            display: block;
            background: rgba(220, 38, 38, 0.12);
            color: var(--error);
        }

        .status.progress {
            display: block;
            background: rgba(37, 99, 235, 0.12);
            color: var(--info);
        }

        .loader-overlay {
            position: fixed;
            inset: 0;
            background: radial-gradient(circle at top, #f8fafc 0%, #e2e8f0 45%, #f1f5f9 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loader-card {
            width: min(520px, 85vw);
            padding: 30px;
            border-radius: 28px;
            background: rgba(255, 255, 255, 0.72);
            border: 1px solid rgba(148, 163, 184, 0.4);
            box-shadow: var(--shadow-lg);
            text-align: center;
        }

        .loader-progress {
            margin-top: 18px;
            height: 6px;
            border-radius: 10px;
            background: rgba(148, 163, 184, 0.3);
            overflow: hidden;
        }

        .loader-progress span {
            display: block;
            height: 100%;
            width: 0;
            background: linear-gradient(90deg, #334155, #64748b, #94a3b8);
            animation: progressLoad 2s linear forwards;
        }

        @keyframes progressLoad {
            0% { width: 0%; }
            100% { width: 100%; }
        }

        .modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(15, 23, 42, 0.55);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9998;
        }

        .modal {
            width: min(520px, 90vw);
            background: var(--surface-strong);
            border-radius: 20px;
            padding: 24px;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .modal h3 {
            margin-bottom: 12px;
        }

        .modal-actions {
            margin-top: 16px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .modal-actions button {
            padding: 10px 16px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
        }

        .btn-secondary {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-primary);
        }

        .btn-primary {
            background: var(--primary-color);
            color: #fff;
        }

        .compare-panel {
            flex: 1;
            border-radius: 14px;
            padding: 14px;
            background: var(--surface-muted);
            border: 1px solid var(--border-color);
        }

        .compare-inline {
            margin-top: 12px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 12px;
        }

        .diff-add {
            background: rgba(34, 197, 94, 0.2);
            border-radius: 6px;
            padding: 0 3px;
        }

        .diff-remove {
            background: rgba(239, 68, 68, 0.15);
            border-radius: 6px;
            padding: 0 3px;
        }

        @media (max-width: 960px) {
            .app-shell {
                grid-template-columns: 1fr;
            }

            .sidebar {
                order: 2;
            }

            .main-panel {
                order: 1;
            }

            .top-bar {
                flex-direction: column;
                align-items: flex-start;
            }

            .message {
                max-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="loader-overlay" id="loader">
        <div class="loader-card">
            <h2>AI 翻译与译审对话系统</h2>
            <p style="margin-top: 6px; color: var(--text-secondary);">Chat-based unified workflow</p>
            <div class="loader-progress"><span></span></div>
        </div>
    </div>

    <div class="modal-overlay" id="apiKeyModal">
        <div class="modal">
            <h3>输入 API Key</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">仅首次使用需要输入，可在设置中清除缓存。</p>
            <input type="password" id="apiKeyInput" placeholder="sk-..." style="width: 100%; margin-top: 12px;">
            <div class="modal-actions">
                <button class="btn-secondary" id="apiKeyClear">清除</button>
                <button class="btn-primary" id="apiKeySave">保存</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="compareModal">
        <div class="modal" style="width: min(800px, 95vw);">
            <h3>更换模型生成对比</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">将使用相同提示重新生成结果，并替换当前输出。</p>
            <input type="text" id="compareModelInput" placeholder="例如：openai/gpt-4o" style="width: 100%; margin-top: 12px;">
            <div class="modal-actions">
                <button class="btn-secondary" id="compareClose">关闭</button>
                <button class="btn-primary" id="compareRun">生成并替换</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reviewModal">
        <div class="modal" style="width: min(520px, 90vw);">
            <h3>译审模型</h3>
            <p style="color: var(--text-secondary); font-size: 0.9rem;">输入用于本次译审的模型名称。</p>
            <input type="text" id="reviewModelInput" placeholder="例如：openai/gpt-4o" style="width: 100%; margin-top: 12px;">
            <div class="modal-actions">
                <button class="btn-secondary" id="reviewClose">取消</button>
                <button class="btn-primary" id="reviewRun">开始译审</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="reviewResultModal">
        <div class="modal" style="width: min(860px, 92vw);">
            <h3>译审结果</h3>
            <div id="reviewResultContent" style="margin-top: 12px;"></div>
            <div class="modal-actions">
                <button class="btn-primary" id="reviewResultClose">关闭</button>
            </div>
        </div>
    </div>

    <div class="app-shell">
        <aside class="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">CHAT</div>
                <button class="sidebar-toggle" id="sidebarToggle"><i class="fas fa-bars"></i></button>
            </div>
            <button class="new-chat-btn" id="newChatBtn"><i class="fas fa-plus"></i> <span>新建对话</span></button>
            <div class="history-list" id="historyList"></div>
            <div class="sidebar-footer">
                <button class="review-entry" id="reviewRecordsEntry">
                    <i class="fas fa-clipboard-check"></i>
                    <span>译审记录</span>
                </button>
            </div>
        </aside>

        <main class="main-panel">
            <div class="top-bar">
                <div class="brand">
                    <h1>AI 翻译与译审对话系统</h1>
                    <span>Chat-based</span>
                </div>
                <div class="control-group">
                    <select class="mode-select" id="modeSelect">
                        <option value="interactive">交互翻译</option>
                        <option value="document">文档翻译</option>
                    </select>
                    <input class="model-input" id="modelInput" type="text" placeholder="模型名称（OpenRouter）">
                    <button class="settings-btn" id="apiKeySettings"><i class="fas fa-key"></i> API Key</button>
                </div>
            </div>

            <section class="chat-area">
                <div class="messages" id="messages"></div>
                <div class="status" id="statusBox"></div>
                <div class="input-panel" id="inputPanel"></div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script>
        const loader = document.getElementById('loader');
        const apiKeyModal = document.getElementById('apiKeyModal');
        const apiKeyInput = document.getElementById('apiKeyInput');
        const apiKeySave = document.getElementById('apiKeySave');
        const apiKeyClear = document.getElementById('apiKeyClear');
        const apiKeySettings = document.getElementById('apiKeySettings');
        const compareModal = document.getElementById('compareModal');
        const compareModelInput = document.getElementById('compareModelInput');
        const compareRun = document.getElementById('compareRun');
        const compareClose = document.getElementById('compareClose');
        const reviewModal = document.getElementById('reviewModal');
        const reviewModelInput = document.getElementById('reviewModelInput');
        const reviewRun = document.getElementById('reviewRun');
        const reviewClose = document.getElementById('reviewClose');
        const reviewResultModal = document.getElementById('reviewResultModal');
        const reviewResultContent = document.getElementById('reviewResultContent');
        const reviewResultClose = document.getElementById('reviewResultClose');
        const modeSelect = document.getElementById('modeSelect');
        const modelInput = document.getElementById('modelInput');
        const messagesEl = document.getElementById('messages');
        const inputPanel = document.getElementById('inputPanel');
        const statusBox = document.getElementById('statusBox');
        const historyList = document.getElementById('historyList');
        const newChatBtn = document.getElementById('newChatBtn');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const reviewRecordsEntry = document.getElementById('reviewRecordsEntry');

        const STORAGE_API_KEY = 'globalApiKey';
        const STORAGE_CONVERSATIONS = 'chatConversations';
        const STORAGE_ACTIVE = 'activeConversationId';
        const STORAGE_REVIEWS = 'reviewRecords';
        const DEFAULT_PREFS = {
            sourceLang: 'auto',
            targetLang: '中文',
            styleNotes: ''
        };

        const LANGUAGE_ALIASES = {
            中文: ['中文', '汉语', '汉文', '简体中文', '繁体中文'],
            英文: ['英文', '英语'],
            日文: ['日文', '日语'],
            韩文: ['韩文', '韩语'],
            俄文: ['俄文', '俄语'],
            德文: ['德文', '德语'],
            法文: ['法文', '法语'],
            西班牙文: ['西班牙文', '西班牙语'],
            葡萄牙文: ['葡萄牙文', '葡萄牙语'],
            意大利文: ['意大利文', '意大利语']
        };

        const SHORT_LANG_MAP = {
            中: '中文',
            英: '英文',
            日: '日文',
            韩: '韩文',
            俄: '俄文',
            德: '德文',
            法: '法文',
            西: '西班牙文',
            葡: '葡萄牙文',
            意: '意大利文'
        };

        const modes = {
            interactive: '交互翻译',
            document: '文档翻译'
        };

        let conversations = [];
        let activeConversationId = null;
        let compareContext = null;
        let reviewContext = null;
        let reviewRecords = [];
        let activeView = 'conversation';

        function ensureConversationDefaults(conversation) {
            if (!conversation.mode) {
                conversation.mode = 'interactive';
            }
            if (!modes[conversation.mode]) {
                conversation.mode = 'interactive';
            }
            if (!conversation.model) {
                conversation.model = '';
            }
            if (!conversation.messages) {
                conversation.messages = [];
            }
            if (!conversation.translationPrefs) {
                conversation.translationPrefs = { ...DEFAULT_PREFS };
            } else {
                conversation.translationPrefs = {
                    ...DEFAULT_PREFS,
                    ...conversation.translationPrefs
                };
            }
        }

        function normalizeLanguage(raw) {
            if (!raw) return '';
            const trimmed = raw.trim();
            for (const [lang, aliases] of Object.entries(LANGUAGE_ALIASES)) {
                if (aliases.includes(trimmed)) {
                    return lang;
                }
            }
            return trimmed;
        }

        function normalizeQuotes(text) {
            if (!text) return '';
            return text
                .replace(/[“”「」『』]/g, '"')
                .replace(/[‘’]/g, "'");
        }

        function extractLanguagePrefs(text) {
            const langPattern = '(中文|英文|日文|韩文|俄文|德文|法文|西班牙文|葡萄牙文|意大利文|汉语|英语|日语|韩语|俄语|德语|法语|西班牙语|葡萄牙语|意大利语|简体中文|繁体中文)';
            const fromToRegex = new RegExp(`从${langPattern}(?:翻译|译)(?:成|为|到|至)${langPattern}`);
            const directRegex = new RegExp(`${langPattern}(?:翻译|译)(?:成|为|到|至)${langPattern}`);
            const toRegex = new RegExp(`(?:翻译|译|改)(?:为|成)${langPattern}`);
            const arrowRegex = new RegExp(`${langPattern}(?:到|至|->|→)${langPattern}`);
            const shortRegex = /([中英日韩俄德法西葡意])译([中英日韩俄德法西葡意])/;

            let sourceLang = '';
            let targetLang = '';

            const fromToMatch = text.match(fromToRegex);
            if (fromToMatch) {
                sourceLang = normalizeLanguage(fromToMatch[1]);
                targetLang = normalizeLanguage(fromToMatch[2]);
                return { sourceLang, targetLang };
            }

            const directMatch = text.match(directRegex);
            if (directMatch) {
                sourceLang = normalizeLanguage(directMatch[1]);
                targetLang = normalizeLanguage(directMatch[2]);
                return { sourceLang, targetLang };
            }

            const arrowMatch = text.match(arrowRegex);
            if (arrowMatch) {
                sourceLang = normalizeLanguage(arrowMatch[1]);
                targetLang = normalizeLanguage(arrowMatch[2]);
                return { sourceLang, targetLang };
            }

            const shortMatch = text.match(shortRegex);
            if (shortMatch) {
                sourceLang = SHORT_LANG_MAP[shortMatch[1]] || '';
                targetLang = SHORT_LANG_MAP[shortMatch[2]] || '';
                return { sourceLang, targetLang };
            }

            const toMatch = text.match(toRegex);
            if (toMatch) {
                targetLang = normalizeLanguage(toMatch[1]);
            }

            return { sourceLang, targetLang };
        }

        function extractStyleNotes(text) {
            const lines = text.split(/\n+/);
            const notes = [];
            lines.forEach(line => {
                const match = line.match(/^(风格|语气|术语|格式|要求|说明)[:：]\s*(.+)$/);
                if (match) {
                    notes.push(match[2].trim());
                }
            });

            const inlineMatch = text.match(/(?:请|保持|使用|采用)([^。！？\n]{1,20})(?:风格|语气|文风|语调|口吻)/);
            if (inlineMatch) {
                notes.push(`${inlineMatch[1].trim()}风格`);
            }

            return notes.filter(Boolean).join('；');
        }

        function updateConversationPrefs(conversation, text) {
            if (!conversation || !text) return;
            const languagePrefs = extractLanguagePrefs(text);
            if (languagePrefs.sourceLang) {
                conversation.translationPrefs.sourceLang = languagePrefs.sourceLang;
            }
            if (languagePrefs.targetLang) {
                conversation.translationPrefs.targetLang = languagePrefs.targetLang;
            }
            const styleNotes = extractStyleNotes(text);
            if (styleNotes) {
                conversation.translationPrefs.styleNotes = styleNotes;
            }
        }

        function buildSystemPrompt(prefs) {
            if (!prefs || !prefs.styleNotes) {
                return '';
            }
            const sourceLabel = prefs.sourceLang === 'auto' ? '自动检测语言' : (prefs.sourceLang || '源语言');
            const targetLabel = prefs.targetLang || '目标语言';
            return (
                `你是一个专业翻译，擅长从${sourceLabel}到${targetLabel}的翻译。` +
                `请保持原文语气、风格一致。\n补充要求：${prefs.styleNotes}`
            );
        }

        function loadState() {
            const storedConversations = localStorage.getItem(STORAGE_CONVERSATIONS);
            if (storedConversations) {
                try {
                    conversations = JSON.parse(storedConversations);
                } catch (error) {
                    conversations = [];
                }
            }
            const storedReviews = localStorage.getItem(STORAGE_REVIEWS);
            if (storedReviews) {
                try {
                    reviewRecords = JSON.parse(storedReviews);
                } catch (error) {
                    reviewRecords = [];
                }
            }
            conversations.forEach(ensureConversationDefaults);
            if (conversations.length === 0) {
                createConversation();
            } else {
                activeConversationId = localStorage.getItem(STORAGE_ACTIVE) || conversations[0].id;
            }
        }

        function saveState() {
            localStorage.setItem(STORAGE_CONVERSATIONS, JSON.stringify(conversations));
            localStorage.setItem(STORAGE_REVIEWS, JSON.stringify(reviewRecords));
            if (activeConversationId) {
                localStorage.setItem(STORAGE_ACTIVE, activeConversationId);
            }
        }

        function createConversation() {
            const id = `conv_${Date.now()}`;
            const conversation = {
                id,
                title: '新对话',
                mode: 'interactive',
                model: '',
                messages: [],
                translationPrefs: { ...DEFAULT_PREFS }
            };
            conversations.unshift(conversation);
            activeConversationId = id;
            activeView = 'conversation';
            saveState();
            renderHistory();
            renderConversation();
        }

        function getActiveConversation() {
            return conversations.find(conv => conv.id === activeConversationId);
        }

        function renderHistory() {
            historyList.innerHTML = '';
            conversations.forEach(conv => {
                const item = document.createElement('div');
                const isActive = activeView === 'conversation' && conv.id === activeConversationId;
                item.className = 'history-item' + (isActive ? ' active' : '');
                item.innerHTML = `
                    <div class="history-title">${conv.title}</div>
                    <div class="history-meta">${modes[conv.mode]}</div>
                `;
                item.addEventListener('click', () => {
                    activeConversationId = conv.id;
                    activeView = 'conversation';
                    saveState();
                    renderHistory();
                    renderConversation();
                });
                historyList.appendChild(item);
            });
            reviewRecordsEntry.classList.toggle('active', activeView === 'reviewRecords');
        }

        function renderConversation() {
            if (activeView === 'reviewRecords') {
                renderReviewRecords();
                return;
            }
            const conversation = getActiveConversation();
            if (!conversation) return;
            ensureConversationDefaults(conversation);
            modeSelect.value = conversation.mode;
            modelInput.value = conversation.model || '';
            messagesEl.innerHTML = '';
            conversation.messages.forEach(message => {
                messagesEl.appendChild(renderMessage(message));
            });
            renderInputPanel(conversation.mode);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function renderReviewRecords() {
            messagesEl.innerHTML = '';
            inputPanel.innerHTML = '';
            showStatus('', '');

            const header = document.createElement('div');
            header.className = 'review-record-title';
            header.textContent = '译审记录';
            messagesEl.appendChild(header);

            if (!reviewRecords.length) {
                const empty = document.createElement('div');
                empty.className = 'review-record-empty';
                empty.textContent = '暂无译审记录。';
                messagesEl.appendChild(empty);
                return;
            }

            reviewRecords.forEach(record => {
                const item = document.createElement('div');
                item.className = 'review-record';

                const timeLabel = record.timestamp ? new Date(record.timestamp).toLocaleString() : '';
                const modelLabel = record.reviewModel || '未标注';
                const translationModels = (record.translations || []).map(t => t.model).filter(Boolean).join('、');

                item.innerHTML = `
                    <div class="review-record-meta">${timeLabel} · 译审模型：${modelLabel}${translationModels ? ` · 译文模型：${translationModels}` : ''}</div>
                    <div class="review-record-title">原文</div>
                    <div>${marked.parse(normalizeQuotes(record.sourceText || ''))}</div>
                    <div class="review-record-title" style="margin-top: 10px;">译审报告</div>
                    <div>${marked.parse(normalizeQuotes(record.report || ''))}</div>
                `;

                messagesEl.appendChild(item);
            });
        }

        function renderMessage(message) {
            const wrapper = document.createElement('div');
            wrapper.className = `message ${message.role}`;

            const bubble = document.createElement('div');
            bubble.className = 'message-bubble';
            const safeContent = normalizeQuotes(message.content || '');
            bubble.innerHTML = marked.parse(safeContent);

            wrapper.appendChild(bubble);

            if (message.role === 'assistant') {
                const footer = document.createElement('div');
                footer.className = 'message-footer';
                const source = document.createElement('div');
                source.className = 'message-source';
                source.textContent = `模型：${message.model || '未标注'}`;
                footer.appendChild(source);

                if (message.comparePayload) {
                    const actions = document.createElement('div');
                    actions.className = 'message-actions';

                    const reviewButton = document.createElement('button');
                    reviewButton.className = 'compare-btn';
                    reviewButton.innerHTML = '<i class="fas fa-clipboard-check"></i> 译审';
                    reviewButton.addEventListener('click', () => openReviewModal(message));
                    actions.appendChild(reviewButton);

                    const switchButton = document.createElement('button');
                    switchButton.className = 'compare-btn';
                    switchButton.innerHTML = '<i class="fas fa-retweet"></i> 更换模型';
                    switchButton.addEventListener('click', () => openCompareModal(message));
                    actions.appendChild(switchButton);

                    if (message.compareHistory && message.compareHistory.length > 1) {
                        const compareButton = document.createElement('button');
                        compareButton.className = 'compare-btn';
                        compareButton.innerHTML = '<i class="fas fa-clone"></i> 对比';
                        compareButton.addEventListener('click', () => toggleCompareView(message));
                        actions.appendChild(compareButton);
                    }

                    footer.appendChild(actions);
                }

                wrapper.appendChild(footer);

                if (message.compareHistory && message.compareHistory.length > 1 && message.compareExpanded) {
                    const compareInline = document.createElement('div');
                    compareInline.className = 'compare-inline';
                    message.compareHistory.forEach(item => {
                        const panel = document.createElement('div');
                        panel.className = 'compare-panel';
                        panel.innerHTML = `
                            <h4>${item.model}</h4>
                            <div>${marked.parse(normalizeQuotes(item.output || ''))}</div>
                        `;
                        compareInline.appendChild(panel);
                    });
                    wrapper.appendChild(compareInline);
                }
            }

            return wrapper;
        }

        function renderInputPanel(mode) {
            inputPanel.innerHTML = '';
            showStatus('', '');

            if (mode === 'interactive') {
                inputPanel.innerHTML = `
                    <textarea id="chatInput" rows="4" placeholder="输入原文或翻译指令..."></textarea>
                    <div class="input-actions">
                        <button class="send-btn" id="sendBtn">发送</button>
                    </div>
                `;
                document.getElementById('sendBtn').addEventListener('click', handleInteractiveSend);
            }

            if (mode === 'document') {
                inputPanel.innerHTML = `
                    <input type="file" id="docFile" accept=".txt,.doc,.docx" />
                    <textarea id="docNotes" rows="3" placeholder="补充说明（可选）"></textarea>
                    <div class="input-actions">
                        <button class="send-btn" id="sendDocBtn">上传翻译</button>
                    </div>
                `;
                document.getElementById('sendDocBtn').addEventListener('click', handleDocumentSend);
            }
        }

        function updateConversationTitle(conversation, text) {
            if (conversation.title !== '新对话') return;
            const trimmed = text.trim();
            if (trimmed) {
                conversation.title = trimmed.slice(0, 12);
            }
        }

        function appendMessage(conversation, message) {
            conversation.messages.push(message);
            messagesEl.appendChild(renderMessage(message));
            messagesEl.scrollTop = messagesEl.scrollHeight;
            saveState();
            renderHistory();
        }

        function showStatus(message, type) {
            if (!message) {
                statusBox.textContent = '';
                statusBox.className = 'status';
                return;
            }
            statusBox.textContent = message;
            statusBox.className = `status ${type}`;
        }

        let statusTimer = null;

        function startStatusSequence(steps) {
            if (!steps || steps.length === 0) return;
            if (statusTimer) {
                clearInterval(statusTimer);
            }
            let index = 0;
            showStatus(steps[index], 'progress');
            statusTimer = setInterval(() => {
                index = (index + 1) % steps.length;
                showStatus(steps[index], 'progress');
            }, 1600);
        }

        function stopStatusSequence(message, type) {
            if (statusTimer) {
                clearInterval(statusTimer);
                statusTimer = null;
            }
            showStatus(message, type);
        }

        async function handleInteractiveSend() {
            const conversation = getActiveConversation();
            const input = document.getElementById('chatInput');
            const text = input.value.trim();
            if (!text) return;
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }
            if (!conversation.model) {
                showStatus('请先输入模型名称。', 'error');
                return;
            }

            updateConversationPrefs(conversation, text);
            const prefs = conversation.translationPrefs || { ...DEFAULT_PREFS };
            const systemPrompt = buildSystemPrompt(prefs);

            updateConversationTitle(conversation, text);
            appendMessage(conversation, { role: 'user', content: text });
            input.value = '';

            startStatusSequence(['正在解析需求', '正在生成译文', '正在润色表达']);
            try {
                const response = await fetch('/translate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        user_message: text,
                        api_key: apiKey,
                        model: conversation.model,
                        temperature: 1.0,
                        source_lang: prefs.sourceLang || 'auto',
                        target_lang: prefs.targetLang || '中文',
                        system_prompt: systemPrompt
                    })
                });
                const result = await response.json();
                if (result.error) {
                    stopStatusSequence(result.error, 'error');
                    return;
                }
                appendMessage(conversation, {
                    role: 'assistant',
                    content: result.translation,
                    model: conversation.model,
                    comparePayload: {
                        mode: 'interactive',
                        baseOutput: result.translation,
                        inputText: text,
                        sourceLang: prefs.sourceLang || 'auto',
                        targetLang: prefs.targetLang || '中文',
                        systemPrompt
                    },
                    compareHistory: [
                        { model: conversation.model || '当前模型', output: result.translation }
                    ],
                    compareExpanded: false
                });
                stopStatusSequence('完成', 'success');
                saveState();
            } catch (error) {
                stopStatusSequence('请求失败，请重试。', 'error');
            }
        }

        async function handleDocumentSend() {
            const conversation = getActiveConversation();
            const fileInput = document.getElementById('docFile');
            const notesInput = document.getElementById('docNotes');
            const file = fileInput.files[0];
            if (!file) {
                showStatus('请先上传文档。', 'error');
                return;
            }
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }
            if (!conversation.model) {
                showStatus('请先输入模型名称。', 'error');
                return;
            }

            if (notesInput.value.trim()) {
                updateConversationPrefs(conversation, notesInput.value.trim());
            }
            const prefs = conversation.translationPrefs || { ...DEFAULT_PREFS };
            appendMessage(conversation, { role: 'user', content: `上传文档：${file.name}\n${notesInput.value.trim()}`.trim() });
            startStatusSequence(['正在解析文档', '正在生成译文', '正在整理译文']);

            const formData = new FormData();
            formData.append('file', file);
            formData.append('api_key', apiKey);
            formData.append('model', conversation.model);
            formData.append('temperature', '1.0');
            formData.append('source_lang', prefs.sourceLang || 'auto');
            formData.append('target_lang', prefs.targetLang || '中文');
            formData.append('system_prompt', notesInput.value || '');
            formData.append('user_prompt', notesInput.value || '');

            try {
                const response = await fetch('/upload', {
                    method: 'POST',
                    body: formData
                });
                const result = await response.json();
                if (result.error) {
                    stopStatusSequence(result.error, 'error');
                    return;
                }
                appendMessage(conversation, {
                    role: 'assistant',
                    content: `文档翻译完成，可下载：\n[下载链接](/download/${result.output_file})`,
                    model: conversation.model
                });
                stopStatusSequence('完成', 'success');
            } catch (error) {
                stopStatusSequence('上传失败，请重试。', 'error');
            }
        }


        function openApiModal() {
            apiKeyModal.style.display = 'flex';
            const storedKey = localStorage.getItem(STORAGE_API_KEY) || '';
            apiKeyInput.value = storedKey;
            apiKeyClear.disabled = !storedKey;
        }

        function closeApiModal() {
            apiKeyModal.style.display = 'none';
        }

        apiKeySave.addEventListener('click', () => {
            const value = apiKeyInput.value.trim();
            if (value) {
                localStorage.setItem(STORAGE_API_KEY, value);
                closeApiModal();
                showStatus('API Key 已保存。', 'success');
            }
        });

        apiKeyClear.addEventListener('click', () => {
            localStorage.removeItem(STORAGE_API_KEY);
            apiKeyInput.value = '';
            apiKeyClear.disabled = true;
        });
        apiKeySettings.addEventListener('click', openApiModal);

        function openCompareModal(message) {
            compareContext = message;
            compareModelInput.value = '';
            compareModal.style.display = 'flex';
        }

        function openReviewModal(message) {
            reviewContext = message;
            reviewModelInput.value = '';
            reviewModal.style.display = 'flex';
        }

        function closeReviewModal() {
            reviewModal.style.display = 'none';
            reviewContext = null;
        }

        compareClose.addEventListener('click', () => {
            compareModal.style.display = 'none';
            compareContext = null;
        });

        reviewClose.addEventListener('click', closeReviewModal);

        reviewResultClose.addEventListener('click', () => {
            reviewResultModal.style.display = 'none';
        });

        compareRun.addEventListener('click', async () => {
            if (!compareContext) return;
            const modelName = compareModelInput.value.trim();
            if (!modelName) return;
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }

            compareRun.disabled = true;
            startStatusSequence(['正在生成对比结果', '正在替换当前结果']);
            try {
                let compareText = '';

                if (!compareContext.comparePayload) {
                    stopStatusSequence('无法对比：缺少上下文。', 'error');
                    compareRun.disabled = false;
                    return;
                }

                if (compareContext.comparePayload.mode === 'interactive') {
                    const response = await fetch('/translate', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            user_message: compareContext.comparePayload.inputText,
                            api_key: apiKey,
                            model: modelName,
                            temperature: 1.0,
                            source_lang: compareContext.comparePayload.sourceLang,
                            target_lang: compareContext.comparePayload.targetLang,
                            system_prompt: compareContext.comparePayload.systemPrompt || ''
                        })
                    });
                    const result = await response.json();
                    if (result.error) {
                        stopStatusSequence(result.error, 'error');
                        return;
                    }
                    compareText = result.translation || '';
                }

                if (compareContext.comparePayload.mode === 'review') {
                    const response = await fetch('/review', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            mode: 'single',
                            source_text: compareContext.comparePayload.sourceText,
                            target_text: compareContext.comparePayload.targetText,
                            source_lang: compareContext.comparePayload.sourceLang,
                            target_lang: compareContext.comparePayload.targetLang,
                            config: { api_key: apiKey, model: modelName }
                        })
                    });
                    const result = await response.json();
                    if (result.error) {
                        stopStatusSequence(result.error, 'error');
                        return;
                    }
                    compareText = `评分：${result.score || 'N/A'}\n\n评估：\n${result.review || ''}\n\n建议：\n${result.suggestions || ''}`;
                }

                if (!compareText) {
                    stopStatusSequence('对比失败，请重试。', 'error');
                    compareRun.disabled = false;
                    return;
                }

                const history = compareContext.compareHistory || [];
                const currentModel = compareContext.model || '当前模型';
                if (!history.find(item => item.model === currentModel)) {
                    history.push({ model: currentModel, output: compareContext.content || '' });
                }

                const existing = history.find(item => item.model === modelName);
                if (existing) {
                    existing.output = compareText;
                } else {
                    history.push({ model: modelName, output: compareText });
                }

                compareContext.compareHistory = history;
                compareContext.content = compareText;
                compareContext.model = modelName;
                compareContext.compareExpanded = false;

                saveState();
                renderConversation();
                compareModal.style.display = 'none';
                compareContext = null;
                stopStatusSequence('对比结果已更新。', 'success');
            } catch (error) {
                stopStatusSequence('对比失败，请重试。', 'error');
            } finally {
                compareRun.disabled = false;
            }
        });

        reviewRun.addEventListener('click', async () => {
            if (!reviewContext) return;
            const modelName = reviewModelInput.value.trim();
            if (!modelName) return;
            const apiKey = localStorage.getItem(STORAGE_API_KEY) || '';
            if (!apiKey) {
                openApiModal();
                return;
            }

            const payload = reviewContext.comparePayload;
            if (!payload) {
                stopStatusSequence('无法译审：缺少上下文。', 'error');
                return;
            }

            const translations = Array.isArray(reviewContext.compareHistory) && reviewContext.compareHistory.length
                ? reviewContext.compareHistory.slice()
                : [{ model: reviewContext.model || '当前模型', output: reviewContext.content || '' }];

            const currentModel = reviewContext.model || '当前模型';
            if (!translations.find(item => item.model === currentModel)) {
                translations.push({ model: currentModel, output: reviewContext.content || '' });
            }

            const translationsSnapshot = translations.map(item => ({
                model: item.model,
                output: item.output
            }));

            reviewRun.disabled = true;
            startStatusSequence(['正在组织译审材料', '正在生成译审报告']);
            try {
                const response = await fetch('/review', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        mode: 'multi',
                        source_text: payload.inputText,
                        source_lang: payload.sourceLang || 'auto',
                        target_lang: payload.targetLang || '中文',
                        translations: translationsSnapshot,
                        config: {
                            api_key: apiKey,
                            model: modelName
                        }
                    })
                });
                const result = await response.json();
                if (result.error) {
                    stopStatusSequence(result.error, 'error');
                    return;
                }

                const report = result.report || result.review || '';
                reviewResultContent.innerHTML = marked.parse(normalizeQuotes(report));
                reviewResultModal.style.display = 'flex';

                reviewRecords.unshift({
                    id: `review_${Date.now()}`,
                    timestamp: new Date().toISOString(),
                    reviewModel: modelName,
                    sourceText: payload.inputText,
                    sourceLang: payload.sourceLang,
                    targetLang: payload.targetLang,
                    translations: translationsSnapshot,
                    report
                });
                saveState();
                stopStatusSequence('译审完成', 'success');
                closeReviewModal();
            } catch (error) {
                stopStatusSequence('译审失败，请重试。', 'error');
            } finally {
                reviewRun.disabled = false;
            }
        });

        function toggleCompareView(message) {
            message.compareExpanded = !message.compareExpanded;
            saveState();
            renderConversation();
        }

        modeSelect.addEventListener('change', () => {
            const conversation = getActiveConversation();
            if (!conversation) return;
            conversation.mode = modeSelect.value;
            activeView = 'conversation';
            saveState();
            renderHistory();
            renderInputPanel(conversation.mode);
        });

        modelInput.addEventListener('input', () => {
            const conversation = getActiveConversation();
            if (!conversation) return;
            conversation.model = modelInput.value.trim();
            saveState();
        });

        newChatBtn.addEventListener('click', createConversation);

        reviewRecordsEntry.addEventListener('click', () => {
            activeView = 'reviewRecords';
            renderHistory();
            renderConversation();
        });

        sidebarToggle.addEventListener('click', () => {
            document.body.classList.toggle('sidebar-collapsed');
        });

        function initLoader() {
            setTimeout(() => {
                loader.style.display = 'none';
                const storedKey = localStorage.getItem(STORAGE_API_KEY);
                if (!storedKey) {
                    openApiModal();
                }
            }, 2000);
        }

        loadState();
        renderHistory();
        renderConversation();
        initLoader();
    </script>
</body>
</html>
